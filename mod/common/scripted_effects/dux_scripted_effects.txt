
DLAF_create_awoken_robot_species = {
	save_event_target_as = DLAF_spawning_location # Also new_colony, potential_target, and colonized_planet in Vanilla; I hate this workaround, but I'm not messing with the localisation.
	if = {
		limit = {
			any_galaxy_species = { has_species_flag = DLAF_awoken_biological }
		}
		random_galaxy_species = {
			limit = { has_species_flag = DLAF_awoken_biological }
			create_species = {
				is_mod = yes
				mod_name_affix = "Name_DLAF_no_prefix1" # "A"
				name = "Name_DLAF_no_prefix2" # "woken" This is to fix "Neo/High/Ultra Awoken"
				plural = "Name_DLAF_no_prefix2"
				class = ROBOT
				namelist = FUN3
				portrait = "default_robot"
				traits = {
					trait = "trait_mechanical"
					trait = "trait_machine_pc_nuked_preference" # This is only here block a random habitability trait.
				}
				effect = {
					set_species_flag = DLAF_awoken_robot
					save_event_target_as = DLAF_awoken_robot_species
					if = {
						limit = {
							any_galaxy_planet = { has_planet_flag = DLAF_awoken_homeworld }
						}
						random_galaxy_planet = {
							limit = { has_planet_flag = DLAF_awoken_homeworld }
							save_event_target_as = DLAF_awoken_homeworld
						}
						set_species_homeworld = event_target:DLAF_awoken_homeworld
					}
				}
			}
		}
	}
	else = {
		create_species = {
			name = "NAME_Awoken_Robot"
			plural = "NAME_Awoken_Robot"
			class = ROBOT
			namelist = FUN3
			portrait = "default_robot"
			traits = {
				trait = "trait_mechanical"
				trait = "trait_machine_pc_nuked_preference" # This is only here block a random habitability trait.
			}
			effect = {
				set_species_flag = DLAF_awoken_robot
				save_event_target_as = DLAF_awoken_robot_species
				if = {
					limit = {
						any_galaxy_planet = { has_planet_flag = DLAF_awoken_homeworld }
					}
					random_galaxy_planet = {
						limit = { has_planet_flag = DLAF_awoken_homeworld }
						save_event_target_as = DLAF_awoken_homeworld
					}
					set_species_homeworld = event_target:DLAF_awoken_homeworld
				}
			}
		}
	}
	event_target:DLAF_awoken_robot_species = {
		if = {
			limit = { has_synthetic_dawn = yes }
			change_species_characteristics = { portrait = "sd_fun_robot" }
		}
	}
	if = { # This monstrosity is to prevent Neo/High/Ultra Awoken.
		limit = {
			OR = {
				is_planet_class = pc_desert
				is_planet_class = pc_arid
				is_planet_class = pc_savannah
			}
		}
		event_target:DLAF_awoken_robot_species = {
			change_species_characteristics = {
				remove_trait = trait_machine_pc_nuked_preference
				add_trait = trait_dry_planet_preference
			}
		}
	}
	else_if = {
		limit = {
			OR = {
				is_planet_class = pc_arctic
				is_planet_class = pc_tundra
				is_planet_class = pc_alpine
			}
		}
		event_target:DLAF_awoken_robot_species = {
			change_species_characteristics = {
				remove_trait = trait_machine_pc_nuked_preference
				add_trait = trait_cold_planet_preference
			}
		}
	}
	else_if = {
		limit = { is_planet_class = pc_volcanic }
		event_target:DLAF_awoken_robot_species = {
			change_species_characteristics = {
				remove_trait = trait_machine_pc_nuked_preference
				add_trait = trait_volcanic_planet_preference
			}
		}
	}
	else = {
		# pc_continental / pc_tropical / pc_ocean / artificial / modded.
		event_target:DLAF_awoken_robot_species = {
			change_species_characteristics = {
				remove_trait = trait_machine_pc_nuked_preference
				add_trait = trait_wet_planet_preference
			}
		}
	}
}

DLAF_create_awoken_robot_country = {
	create_country = {
		name = "NAME_Awoken"
		name_list = FUN3
		species = event_target:DLAF_awoken_robot_species
		type = default
		ethos = {
			ethic = ethic_fanatic_materialist
			ethic = ethic_xenophile
		}
		authority = random
		civics = random
		flag = {
			icon = { category = "blocky" file = "flag_blocky_21.dds" }
			background = { category = "backgrounds" file = "new_dawn.dds" }
			colors = { "black" "dark_blue" "null" "null" }
		}
		graphical_culture = fungoid_01 # Fixes bioship issues.
		day_zero_contact = no # To prevent instant first contacts with spacefauna, enclaves, and FEs.
		exclude_day_zero_contact = root
		effect = {
			establish_communications_no_message = root
			root = {
				every_federation_ally = { establish_communications = prevprev }
			}
			save_event_target_as = awoken_country
			set_country_flag = limbo_country
			set_country_flag = synthetic_empire
			set_policy = { # This policy must be set before pops are spawned in order to prevent them being pop_category robot_servant.
				policy = artificial_intelligence_policy
				option = ai_full_rights
			}
			create_leader = {
				class = random_ruler
				species = owner_species
				name = random
				skill = 5
			}
			set_leader = last_created_leader
			copy_techs_from = {
				target = root
				except = {
					# Food
					tech_gene_crops
					tech_nano_vitality_crops
					tech_nutrient_replication
					# Misc
					tech_frontier_health
					tech_frontier_hospital
					tech_telepathy
					tech_precognition_interface
					tech_psi_jump_drive_1
					tech_galactic_markets
					tech_subdermal_stimulation
					tech_global_research_initiative
					tech_neural_implants
					tech_psionic_theory
					# Genetics
					tech_genome_mapping
					tech_vitality_boosters
					tech_epigenetic_triggers
					tech_cloning
					tech_gene_banks
					tech_gene_seed_purification
					tech_morphogenetic_field_mastery
					tech_gene_tailoring
					tech_glandular_acclimation
					tech_gene_expressions
					tech_selected_lineages
					tech_capacity_boosters
					# Horizon Signal
					tech_akx_worm_1
					tech_akx_worm_2
					tech_akx_worm_3
				}
			}
			# Granted resources equivalent to 1/5 of what Pre-FTLs get.
			add_resource = {
				energy = 100
				minerals = 100
				consumer_goods = 50
				alloys = 25
				influence = 10
				unity = 50
				volatile_motes = 10
				exotic_gases = 10
				rare_crystals = 10
				mult = trigger:years_passed
			}
			# They are now grateful you saved them.
			add_opinion_modifier = { modifier = unique_event_savior_opinion_modifier who = root }
			add_trust = { # Vanilla trust not always added. Moved here for clarity.
				amount = 50
				who = root
			}
			if = {
				limit = {
					root = { has_technology = tech_maulers }
				}
				give_technology = { tech = tech_corvettes }
				give_technology = { tech = tech_torpedoes_1 }
			}
			if = {
				limit = {
					root = { has_technology = tech_weavers }
				}
				give_technology = { tech = tech_destroyers }
			}
			if = {
				limit = {
					root = { has_technology = tech_stingers }
				}
				give_technology = { tech = tech_battleships }
			}
			if = {
				limit = {
					root = { has_technology = tech_harbingers }
				}
				give_technology = { tech = tech_cruisers }
			}
			# If released by an Individualist Machine these techs can't be copied and must be granted manually so the Awoken can have an economy.
			if = {
				limit = {
					NOT = { has_technology = tech_robotic_workers }
				}
				give_technology = { tech = tech_robotic_workers }
			}
			if = {
				limit = {
					NOT = { has_technology = tech_droid_workers }
				}
				give_technology = { tech = tech_droid_workers }
			}
			if = {
				limit = {
					NOT = { has_technology = tech_synthetic_workers }
				}
				give_technology = { tech = tech_synthetic_workers }
			}
			if = {
				limit = {
					NOT = { has_technology = tech_synthetic_leaders }
				}
				give_technology = { tech = tech_synthetic_leaders }
			}
			# Make spacefauna friendly if Awakener is friendly.
			if = {
				limit = {
					root = { has_modifier = pacified_amoebas }
				}
				add_modifier = { modifier = pacified_amoebas days = -1 }
				every_country = {
					limit = { is_amoeba_country_type = yes }
					set_faction_hostility = { set_neutral = yes target = event_target:awoken_country }
				}
			}
			if = {
				limit = {
					root = { has_modifier = pacified_crystals }
				}
				add_modifier = { modifier = pacified_crystals days = -1 }
				every_country = {
					limit = { is_crystal_country_type = yes }
					set_faction_hostility = { set_neutral = yes target = event_target:awoken_country }
				}
			}
			while = { # These make no sense for synths.
				count = 5 # Just for safety
				limit = {
					OR = {
						has_civic = civic_genetic_identification
						has_civic = civic_corporate_genetic_identification
						has_civic = civic_catalytic_processing
						has_civic = civic_corporate_catalytic_processing
						has_civic = civic_toxic_baths
						has_civic = civic_corporate_toxic_baths
						has_civic = civic_permanent_employment
						has_civic = civic_private_healthcare_corporate
						has_civic = civic_environmental_architects
						has_civic = civic_environmental_architects_megacorp
						has_civic = civic_beastmasters
						has_civic = civic_corporate_beastmasters
						has_civic = civic_entropy_drinkers
						has_civic = civic_entropy_drinkers_corporate
					}
				}
				change_government = { civics = random }
			}
		}
	}
}

DLAF_spawn_awoken = {
	if = {
		limit = {
			any_system = {
				DLAF_is_valid_awoken_country_colony_system_trigger = yes # Exported to scripted trigger for consistency.
				any_system_planet = { DLAF_is_valid_awoken_colony_trigger = yes }
			}
		}
		random_galaxy_planet = {
			limit = {
				DLAF_is_valid_awoken_colony_trigger = yes
				solar_system = {
					DLAF_is_valid_awoken_country_colony_system_trigger = yes # Exported to scripted trigger for consistency.
				}
			}
			weights = {
				base = 1
				modifier = { factor = 2 planet_size > 10 }
				modifier = { factor = 2 free_district_slots > 6 }
				# Energy is a priority.
				modifier = {
					factor = 2
					OR = {
						num_free_districts = { type = district_generator value > 2 }
						num_free_districts = { type = district_geothermal value > 2 } # These are always uncapped.
						num_free_districts = { type = district_hab_energy value > 2 }
						num_free_districts = { type = district_rw_generator value > 2 }
					}
				}
				modifier = {
					factor = 3
					OR = {
						has_modifier = hazardous_weather
						has_modifier = strong_magnetic_field
					}
				}
				modifier = { factor = 0.5 has_modifier = energy_poor }
				# Minerals also important.
				modifier = {
					factor = 2
					OR = {
						num_free_districts = { type = district_mining value > 2 }
						num_free_districts = { type = district_melting value > 2 }
						num_free_districts = { type = district_hab_mining value > 2 }
					}
				}
				modifier = {
					factor = 1.5
					OR = {
						has_modifier = asteroid_belt
						has_modifier = mineral_rich
						has_modifier = ultra_rich
						has_modifier = extensive_moon_system
						has_modifier = asteroid_impacts
						has_modifier = carbon_world
						# Volcanic Worlds
						has_modifier = volcanic_mineral_rich
						has_modifier = volcanic_ultra_rich
						has_modifier = volcanic_subterranean
						has_modifier = volcanic_asteroid_impacts
						has_modifier = volcanic_hollow_planet
						has_modifier = volcanic_lavafall
					}
				}
				modifier = { factor = 0.5 has_modifier = mineral_poor }
			}
			save_event_target_as = colonized_planet
			set_surveyed = { surveyed = yes surveyor = root }
			prevent_anomaly = yes
			DLAF_create_awoken_robot_species = yes
			DLAF_create_awoken_robot_country = yes
			set_owner = last_created_country
			set_capital = yes
			set_timed_planet_flag = { flag = ignore_ai_building_limitations days = 1 }
			if = {
				limit = { # Have to have this check to stop an error saying they don't exist and then spawning them.
					exists = event_target:DLAF_awoken_robot_species
				}
				create_pop_group = {
					species = event_target:DLAF_awoken_robot_species
					category = civilian
					size = 600
				}
			}
			owner = { refresh_leader_pool = yes } # Must occur after they have at least 1 pop.
			while = { # District swaps based on planet type.
				count = 2
				if = {
					limit = { is_planet_class = pc_volcanic }
					add_district_if_possible_effect = {
						district = district_melting
					}
					add_district_if_possible_effect = {
						district = district_geothermal
					}
					add_district_if_possible_effect = {
						district = district_city
					}
				}
				else_if = {
					limit = { is_planet_class = pc_habitat }
					add_district_if_possible_effect = {
						district = district_hab_mining
					}
					add_district_if_possible_effect = {
						district = district_hab_energy
					}
					add_district_if_possible_effect = {
						district = district_hab_housing
					}
				}
				else_if = {
					limit = { is_planet_class = pc_ringworld_habitable }
					add_district_if_possible_effect = {
						district = district_rw_generator
					} # Ringword districts add more jobs. No Mining Equivalent.
					add_district_if_possible_effect = {
						district = district_rw_city
					}
				}
				else = {
					add_district_if_possible_effect = {
						district = district_generator
					}
					add_district_if_possible_effect = {
						district = district_mining
					}
					add_district_if_possible_effect = {
						district = district_city
					}
				}
			}
			if = {
				limit = {
					NOT = { has_zone = { zone = zone_research_unity } }
				}
				add_zone = { zone = zone_research_unity replace = yes }
			}
			if = {
				limit = {
					NOT = { has_zone = { zone = zone_industrial } }
				}
				add_zone = { zone = zone_industrial replace = yes }
			}
			add_building = { building = building_factory_1 zone = zone_industrial }
			add_building = building_robot_assembly_plant
			validate_planet_buildings_and_districts = yes # This should fix incorrect districts if they happen.
			solar_system = {
				create_starbase = {
					owner = event_target:awoken_country
					size = starbase_starport
					module = shipyard
					module = shipyard
					building = crew_quarters
				}
			}
			root = {
				country_event = { id = anomaly.1196 days = 10 }
			}
		}
	}
	else = {
		# There are no colonizable planets outside the player's borders
		[[ELSE]
		country_event = { id = anomaly.1195 days = 40 }
		]
	}
}

inherit_tech_effect = {
	## Copy technologies
	if = {
		limit = {
			NOT = { exists = event_target:tech_country }
		}
		if = {
			limit = {
				any_neighbor_country = {
					is_scope_valid = yes
					is_country_type = default
					NOT = { has_ascension_perk = ap_enigmatic_engineering } # Vfix
				}
			}
			random_neighbor_country = {
				limit = {
					is_country_type = default
					NOT = { has_ascension_perk = ap_enigmatic_engineering }
				}
				weights = {
					base = 1
					modifier = {
						factor = 50
						NOT = { is_same_value = root }
					}
				}
				save_event_target_as = tech_country
			}
		}
		else_if = {
			limit = {
				any_playable_country = {
					NOR = {
						is_ai = yes
						has_ascension_perk = ap_enigmatic_engineering
					}
				}
			}
			random_playable_country = {
				limit = {
					NOR = {
						is_ai = yes
						has_ascension_perk = ap_enigmatic_engineering
					}
				}
				weights = {
					base = 1
					modifier = {
						factor = 50
						NOT = { is_same_value = root }
					}
				}
				save_event_target_as = tech_country
			}
		}
		else = {
			random_playable_country = {
				limit = {
					NOT = { has_ascension_perk = ap_enigmatic_engineering }
				}
				weights = {
					base = 1
					modifier = {
						factor = 50
						NOT = { is_same_value = root }
					}
				}
				save_event_target_as = tech_country
			}
		}
	}
	copy_techs_from = {
		target = event_target:tech_country
		except = {
			# Horizon Signal
			tech_akx_worm_1
			tech_akx_worm_2
			tech_akx_worm_3
		}
	}
	if = {
		limit = {
			NOT = { has_technology = tech_corvettes }
		}
		give_technology = { tech = tech_corvettes }
	}
	if = {
		limit = {
			NOT = { has_technology = tech_torpedoes_1 }
			event_target:tech_country = { has_technology = tech_maulers } # Vfix scope
		}
		give_technology = { tech = tech_torpedoes_1 }
	}
	if = {
		limit = {
			NOT = { has_technology = tech_destroyers }
			event_target:tech_country = { has_technology = tech_weavers }
		}
		give_technology = { tech = tech_destroyers }
	}
	if = {
		limit = {
			NOT = { has_technology = tech_cruisers }
			event_target:tech_country = { has_technology = tech_harbingers }
		}
		give_technology = { tech = tech_cruisers }
	}
	if = {
		limit = {
			NOT = { has_technology = tech_battleships }
			event_target:tech_country = { has_technology = tech_stingers }
		}
		give_technology = { tech = tech_battleships }
	}
	if = {
		limit = {
			NOT = { has_technology = tech_starbase_2 }
		}
		give_technology = { tech = tech_starbase_2 }
	}

	## Add some new technologies
	inverted_switch = {
		trigger = has_technology
		tech_starbase_3 = { give_technology = { tech = tech_starbase_3 } }
		tech_starbase_4 = { give_technology = { tech = tech_starbase_4 } }
		tech_starbase_5 = { give_technology = { tech = tech_starbase_5 } }
		tech_power_plant_4 = { give_technology = { tech = tech_power_plant_4 } }
		tech_mining_3 = { give_technology = { tech = tech_mining_3 } }
		tech_power_hub_1 = { give_technology = { tech = tech_power_hub_1 } }
	}
	## Add resources

	add_resource = {
		minerals = 10000
		energy = 10000
		food = 3000
		consumer_goods = 3000
		alloys = 7000
		influence = 1000
		unity = 27000
	}
}
