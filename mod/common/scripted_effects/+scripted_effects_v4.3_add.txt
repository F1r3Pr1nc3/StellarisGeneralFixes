## REMOVEME at v4.4
## = shortdocu = ##
#
## = ADDED = ##
# spawn_eater_fleet_effect
# refuge_pop_group
#
spawn_eater_fleet_effect = {
	if = {
		limit = {
			NOT = { is_variable_set = eater_fleet_intensity }
		}
		set_variable = { which = eater_fleet_intensity value = 0 }
	}
	if = {
		limit = {
			any_owned_fleet = { has_fleet_flag = eater_fleet }
		}
		every_owned_fleet = {
			limit = { has_fleet_flag = eater_fleet }
			delete_fleet = this
		}
	}

	# if = { v4.3
	# 	limit = {
	# 		check_variable_arithmetic = {
	# 			which = eater_fleet_intensity
	# 			add = 3
	# 			value >= 12
	# 		}
	# 	}
	# 	create_random_fleet = {
	# 		size = value:eater_fleet_scaling
	# 		can_overflow = yes
	# 		ship_designs = {
	# 			NAME_Tooth_Eater
	# 			NAME_Fang_Eater
	# 			NAME_Tusk_Eater
	# 		}
	# 	}
	# }
	# else_if = {
	# 	limit = {
	# 		check_variable_arithmetic = {
	# 			which = eater_fleet_intensity
	# 			add = 3
	# 			value >= 6
	# 		}
	# 	}
	# 	create_random_fleet = {
	# 		size = value:eater_fleet_scaling
	# 		can_overflow = yes
	# 		ship_designs = { NAME_Tooth_Eater NAME_Fang_Eater }
	# 	}
	# }
	# else = {
	# 	create_random_fleet = {
	# 		size = value:eater_fleet_scaling
	# 		can_overflow = yes
	# 		ship_designs = { NAME_Tooth_Eater }
	# 	}
	# }
	create_fleet_from_naval_cap = value:eater_fleet_scaling # v4.2-v4.3 beta

	last_created_fleet = {
		set_fleet_settings = {
			can_upgrade = no
			can_change_composition = no
			uses_naval_capacity = no
			spawn_debris = no
			can_disband = no
		}
		set_name = Name_Doom_Eater_Fleet
		set_owner = root
		set_location = { target = event_target:eater_planet }
		set_fleet_flag = eater_fleet
		save_event_target_as = eater_fleet
	}
	set_variable = { which = eater_fleet_intensity value = 0 }
}

create_unbidden_fleet = {
	event_target:extradimensionals = {
		# Create Admiral
		# Vfix leader spam: old admirals often survive the fleet kill, so there are a lot
		if = {
			limit = {
				count_owned_leader = { count < 25 }
			}
			random = {
				chance = 50
				create_leader = {
					class = commander
					species = owner_species
					name = random
					skill = 3
					effect = {
						random_list = {
							25 = { add_trait = { trait = leader_trait_ethereal } }
							25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
							50 = {  }
						}
						save_event_target_as = exd_leader
					}
				}
			}
		}
		else = {
			random_owned_leader = {
				limit = {
					leader_class = commander
					is_idle = yes
					NOR = {
						is_ruler = yes
						exists = fleet
					}
				}
				save_event_target_as = exd_leader
			}
		}
		if = { # Vfix compat.
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			root = {
				if = {
					limit = { is_scope_type = fleet }
					save_event_target_as = dimensional_portal
				}
			}
			else = {
				event_target:portal_holder_1 = {
					random_controlled_fleet = {
						limit = {
							is_ship_size = dimensional_portal_ed
							is_within_borders_of = prevprev
						}
						save_event_target_as = dimensional_portal
					}
				}
			}
		}
		create_fleet = {
			effect = {
				set_owner = prev
				while = {
					count = 4
					create_ship = {
						name = random
						design = "NAME_Revenant"
						graphical_culture = "extra_dimensional_01"
					}
				}
				if = {
					limit = { exists = event_target:exd_leader }
					assign_leader = event_target:exd_leader
				}
				while = {
					count = 5
					create_ship = {
						name = random
						design = "NAME_Phantom"
						graphical_culture = "extra_dimensional_01"
					}
				}
				while = {
					count = 10
					create_ship = {
						name = random
						design = "NAME_Wraith"
						graphical_culture = "extra_dimensional_01"
					}
				}
				set_location = {
					target = event_target:dimensional_portal
					distance = 5
					angle = random
				}
				set_fleet_stance = aggressive
				set_aggro_range = 500
				set_aggro_range_measure_from = self
				set_fleet_bombardment_stance = armageddon
			}
		}
	}
}

create_aberrant_fleet = {
	event_target:extradimensionals2 = {
		# Create Admiral
		# Vfix leader spam: old admirals often survive the fleet kill, so there are a lot
		if = {
			limit = {
				count_owned_leader = { count < 25 }
			}
			random = {
				chance = 50
				create_leader = {
					class = commander
					species = owner_species
					name = random
					skill = 3
					effect = {
						random_list = {
							25 = { add_trait = { trait = leader_trait_ethereal } }
							25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
							50 = {  }
						}
						save_event_target_as = exd_leader
					}
				}
			}
		}
		else = {
			random_owned_leader = {
				limit = {
					leader_class = commander
					is_idle = yes
					NOR = {
						is_ruler = yes
						exists = fleet
					}
				}
				save_event_target_as = exd_leader
			}
		}
		if = { # Vfix compat.
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			root = {
				if = {
					limit = { is_scope_type = fleet }
					save_event_target_as = dimensional_portal
				}
			}
			else = {
				event_target:portal_holder_1 = {
					random_controlled_fleet = {
						limit = {
							is_ship_size = dimensional_portal_ed
							is_within_borders_of = prevprev
						}
						save_event_target_as = dimensional_portal
					}
				}
			}
		}
		# Create Fleet
		create_fleet = {
			effect = {
				set_owner = root
				while = {
					count = 3
					create_ship = {
						name = random
						design = "NAME_Huntress"
						graphical_culture = "extra_dimensional_02"
					}
				}
				if = {
					limit = { exists = event_target:exd_leader }
					assign_leader = event_target:exd_leader
				}
				while = {
					count = 5
					create_ship = {
						name = random
						design = "NAME_Assassin"
						graphical_culture = "extra_dimensional_02"
					}
				}
				while = {
					count = 10
					create_ship = {
						name = random
						design = "NAME_Predator"
						graphical_culture = "extra_dimensional_02"
					}
				}
				set_location = {
					target = event_target:dimensional_portal
					distance = 5
					angle = random
				}
				set_fleet_stance = aggressive
				set_aggro_range = 500
				set_aggro_range_measure_from = self
				set_fleet_bombardment_stance = armageddon
			}
		}
	}
}

create_vehement_fleet = {
	event_target:extradimensionals3 = {
		# Create Admiral
		# Vfix leader spam: old admirals often survive the fleet kill, so there are a lot
		if = {
			limit = {
				count_owned_leader = { count < 25 }
			}
			random = {
				chance = 50
				create_leader = {
					class = commander
					species = owner_species
					name = random
					skill = 3
					effect = {
						random_list = {
							25 = { add_trait = { trait = leader_trait_ethereal } }
							25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
							50 = {  }
						}
						save_event_target_as = exd_leader
					}
				}
			}
		}
		else = {
			random_owned_leader = {
				limit = {
					leader_class = commander
					is_idle = yes
					NOR = {
						is_ruler = yes
						exists = fleet
					}
				}
				save_event_target_as = exd_leader
			}
		}
		if = { # Vfix compat.
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			root = {
				if = {
					limit = { is_scope_type = fleet }
					save_event_target_as = dimensional_portal
				}
			}
			else = {
				event_target:portal_holder_1 = {
					random_controlled_fleet = {
						limit = {
							is_ship_size = dimensional_portal_ed
							is_within_borders_of = prevprev
						}
						save_event_target_as = dimensional_portal
					}
				}
			}
		}
		# Create Fleet
		create_fleet = {
			effect = {
				set_owner = root
				while = {
					count = 3
					create_ship = {
						name = random
						design = "NAME_Eradicator"
						graphical_culture = "extra_dimensional_03"
					}
				}
				if = {
					limit = { exists = event_target:exd_leader }
					assign_leader = event_target:exd_leader
				}
				while = {
					count = 5
					create_ship = {
						name = random
						design = "NAME_Annihilator"
						graphical_culture = "extra_dimensional_03"
					}
				}
				while = {
					count = 10
					create_ship = {
						name = random
						design = "NAME_Obliterator"
						graphical_culture = "extra_dimensional_03"
					}
				}
				set_location = {
					target = event_target:dimensional_portal
					distance = 5
					angle = random
				}
				set_fleet_stance = aggressive
				set_aggro_range = 500
				set_aggro_range_measure_from = self
				set_fleet_bombardment_stance = armageddon
			}
		}
	}
}
