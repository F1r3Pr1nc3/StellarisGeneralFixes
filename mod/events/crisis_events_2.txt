############################
#
# Crisis Events II
#
# Written by Henrik Thyrwall
#
# Revised by FirePrince 12/2025
#
############################

namespace = crisis

### EXTRADIMENSIONALS
# country_event = {
# 	id = crisis.10001
# 	hide_window = yes
# 	is_test_event = yes
# 	trigger = {
# 		always = no
# 	}
# 	immediate = {
# 		if = {
# 			limit = {
# 				NOT = { exists = event_target:portal_holder_1 }
# 			}
# 			create_country = {
# 				name = "NAME_Portal_Holder_1"
# 				type = portal_holder
# 				flag = {
# 					icon = { category = "special" file = "extradimensional_01.dds" }
# 					background = { category = "backgrounds" file = "circle.dds" }
# 					colors = { "black" "black" "null" "null" }
# 				}
# 				effect = {
# 					save_global_event_target_as = portal_holder_1
# 					every_playable_country = {
# 						establish_communications_no_message = prev
# 					}
# 				}
# 			}
# 		}
# 		# if = {
# 		#	limit = { NOT = { any_country = { is_country_type = extradimensional has_country_flag = unbidden } } }
# 		random_country = {
# 			limit = { is_country_type = extradimensional }
# 			set_country_flag = unbidden
# 		}
# 		# }
# 		random_country = {
# 			limit = { is_country_type = portal_holder }
# 			random_controlled_ship = { set_ship_flag = unbidden_portal }
# 		}
# 	}
# }
# country_event = {
# 	id = crisis.10002
# 	hide_window = yes
# 	trigger = {
# 		always = no
# 	}
# 	is_test_event = yes
# 	immediate = {
# 		random_country = {
# 			limit = { is_country_type = portal_holder }
# 			random_controlled_ship = { set_ship_flag = unbidden_portal }
# 		}
# 	}
# }
# Extradimensional Invasion Begins (HIDDEN)
country_event = {
	id = crisis.1000
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	immediate = {
		set_crisis_sound = extradimensional_crisis_ambient_stage_1
		set_crisis_stage_1 = yes
		create_country = {
			name = "NAME_Portal_Holder_1"
			type = portal_holder
			flag = {
				icon = { category = "special" file = "extradimensional_01.dds" }
				background = { category = "backgrounds" file = "circle.dds" }
				colors = { "black" "black" "null" "null" }
			}
			effect = {
				save_global_event_target_as = portal_holder_1
				every_playable_country = { establish_communications_no_message = prev }
			}
		}
		awaken_guardians_of_the_galaxy = yes
		endgame_telemetry = extradimensional
		set_global_flag = extradimensional_invasion_happened
		set_global_flag = galactic_crisis_happened
		random_system = {
			limit = {
				NOR = {
					is_system_home_to_crystalline_entity = yes
					is_binary_star = yes
					has_star_flag = crisis_spawn_exclude
					AND = {
						exists = owner
						owner = { is_fallen_empire = yes }
					}

				}
				NAND = { # Vfix
					num_cosmic_storms > 0
					is_inside_storm = yes
					is_storm_type = electric_storm
				}
			}
			set_star_flag = extradimensional_origin_system
			save_event_target_as = extradimensional_system
			random_system_planet = {
				create_species = {
					name = "NAME_Unbidden"
					class = EXD
					namelist = Extradimensional
					portrait = exd1_leader
					traits = random
					effect = {
						save_event_target_as = extradimensional_species
					}
				}
				create_country = {
					name = "NAME_Unbidden"
					type = "extradimensional"
					species = event_target:extradimensional_species
					name_list = "Extradimensional"
					flag = {
						icon = { category = "special" file = "extradimensional_01.dds" }
						background = { category = "backgrounds" file = "circle.dds" }
						colors = { "indigo" "blue" "null" "null" }
					}
					effect = {
						set_country_flag = unbidden # Vfix: not used?
						create_ship_design = { design = "NAME_Void_Shaper" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Unbidden_Anchor" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Unbidden_Starbase" }
						add_ship_design = last_created_design
						save_event_target_as = extradimensionals
						save_global_event_target_as = extradimensionals
						establish_communications_no_message = event_target:portal_holder_1
						set_faction_hostility = { target = event_target:portal_holder_1 set_hostile = no }
						set_graphical_culture = extra_dimensional_01
					}
				}
				event_target:extradimensionals = {
					create_fleet = {
						name = "NAME_Dimensional_Portal"
						effect = {
							set_owner = prev
							create_ship = {
								name = random
								design = "NAME_Unbidden_Portal"
								graphical_culture = "extra_dimensional_01"
								effect = {
									set_ship_flag = unbidden_portal
								}
							}
							set_location = {
								target = prevprev
								distance = 40
								angle = random
							}
							save_event_target_as = dimensional_portal
							fleet_event = { id = crisis.1003 days = 15 } # Second Fleet Arrives
							fleet_event = { id = crisis.1003 days = 30 } # Third Fleet Arrives
							fleet_event = { id = crisis.1003 days = 55 } # Fourth Fleet Arrives
							fleet_event = { id = crisis.1003 days = 90 } # Fifth Fleet Arrives
							fleet_event = { id = crisis.1003 days = 180 } # Sixth Fleet Arrives
							fleet_event = { id = crisis.1003 days = 265 } # Seventh Fleet Arrives
							fleet_event = { id = crisis.1003 days = 340 } # Eight Fleet Arrives
							fleet_event = { id = crisis.1003 days = 425 } # Ninth Fleet Arrives
							fleet_event = { id = crisis.1003 days = 550 } # Tenth Fleet Arrives
							fleet_event = { id = crisis.1006 days = 20 } # First Constructor Arrives
							fleet_event = { id = crisis.1006 days = 25 } # Second Constructor Arrives
							fleet_event = { id = crisis.1006 days = 160 } # Third Constructor Arrives
							fleet_event = { id = crisis.1006 days = 310 } # Fourth Constructor Arrives
							prev = { country_event = { id = crisis.1260 days = 350 } } # Spawn Cycle starts
							# set_owner = event_target:portal_holder_1 #when first anchor built
						}
					}
					create_leader = {
						class = commander
						species = event_target:extradimensional_species
						name = random
						skill = 3
						traits = { trait = leader_trait_ethereal }
					}
					create_fleet = {
						effect = {
							set_owner = prev
							while = {
								count = 21
								create_ship = {
									name = random
									design = "NAME_Revenant"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 30
								create_ship = {
									name = random
									design = "NAME_Phantom"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 45
								create_ship = {
									name = random
									design = "NAME_Wraith"
									graphical_culture = "extra_dimensional_01"
								}
							}
							set_location = {
								target = event_target:dimensional_portal
								distance = 5
								angle = random
							}
							set_fleet_stance = aggressive
							set_aggro_range = 500
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = armageddon
							assign_leader = last_created_leader
						}
					}
				}
			}
			if = {
				limit = { exists = starbase }
				starbase = { destroy_fleet = fleet }
			}
			create_starbase = { size = starbase_exd owner = event_target:extradimensionals }
			star = {
				create_ambient_object = { type = "extradimensional_2" location = this }
				last_created_ambient_object = {
					set_ambient_object_flag = extradimensional_system_effect_2
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
		}
		observer_event = { id = observer.34 }
		# make portal invincible
		event_target:extradimensionals = {
			country_event = { id = crisis.1280 }
		}
		# Custodian/Emperor Announcements
		event_target:extradimensionals = { save_event_target_as = crisis_country }
		if = {
			limit = { has_galactic_custodian = yes }
			random_playable_country = {
				limit = { is_galactic_custodian = yes }
				country_event = { id = custodian.50 days = 30 }
			}
		}
		if = {
			limit = { has_galactic_emperor = yes }
			event_target:gal_emperor = {
				country_event = { id = emperor.90 days = 30 }
			}
		}
		# Vfix opt
		every_country = {
			limit = { is_default_or_fallen = yes }
			if = {
				limit = {
					intel_level = { level = high system = event_target:extradimensional_system }
				}
				country_event = { id = crisis.1007 }
			}
			else = {
				country_event = { id = crisis.1008 }
			}
		}
	}

	after = {
		every_playable_country = {
			country_event = { id = timeline.67 } # Timeline Unbidden Crisis
		}
	}
}

# Fleet Reinforcements
fleet_event = {
	id = crisis.1003
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensionals = {
			create_leader = {
				class = commander
				species = event_target:extradimensional_species
				name = random
				skill = 3
				effect = {
					random_list = {
						25 = { add_trait = { trait = leader_trait_ethereal } }
						25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
						50 = {  }
					}
				}
			}
			create_fleet = {
				effect = {
					set_owner = prev
					while = {
						count = 9
						create_ship = {
							name = random
							design = "NAME_Revenant"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 12
						create_ship = {
							name = random
							design = "NAME_Phantom"
							graphical_culture = "extra_dimensional_01"
						}
					}
					while = {
						count = 20
						create_ship = {
							name = random
							design = "NAME_Wraith"
							graphical_culture = "extra_dimensional_01"
						}
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
					set_fleet_bombardment_stance = armageddon
					assign_leader = last_created_leader
				}
			}
		}
	}
}

# Constructor
fleet_event = {
	id = crisis.1006
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensionals = {
			create_fleet = {
				effect = {
					set_owner = prev
					create_ship = {
						name = random
						design = "NAME_Void_Shaper"
						graphical_culture = "extra_dimensional_01"
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
				}
			}
		}
	}
}

# Notification (High Intel)
country_event = {
	id = crisis.1007
	title = "crisis.1007.name"
	desc = "crisis.1007.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:extradimensional_system
	is_triggered_only = yes

	after = {
		begin_event_chain = { event_chain = "extradimensional_invasion_chain" target = root }
		if = { # Vfix patch
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			event_target:extradimensional_system = {
				random_fleet_in_system = {
					limit = { is_ship_size = dimensional_portal_ed }
					save_event_target_as = dimensional_portal
				}
			}
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.1
			name = "extradimensional_invasion_1_poi"
			desc = "extradimensional_invasion_1_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:extradimensional_system
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.4
			name = "extradimensional_invasion_4_poi"
			desc = "extradimensional_invasion_4_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:dimensional_portal # Vfix minor
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain"
				counter = "dimensional_anchors_1"
				amount = 1
			}
			country_event = { id = crisis.1010 }
		}
		if = {
			limit = {
				any_planet_within_border = {
					has_planet_flag = fotd_seperatist_planet@root
					owner = { has_country_flag = fotd_seperatist_country@root }
				}
			}
			country_event = { id = origin.6130 days = 5 random = 2 }
		}
	}

	option = {
		name = crisis.18.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_government = gov_wilderness
				has_government = gov_parasitic_overmind
				has_government = gov_successor_khanate
				has_government = gov_diadochi
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.g
		trigger = { has_ethic = "ethic_fanatic_xenophobe" }
	}
	option = {
		name = crisis.1007.a
		trigger = { has_ethic = "ethic_fanatic_xenophile" }
	}
	option = {
		name = crisis.1007.b
		trigger = { has_ethic = "ethic_fanatic_authoritarian" }
	}
	option = {
		name = crisis.18.j
		trigger = { has_ethic = "ethic_fanatic_egalitarian" }
	}
	option = {
		name = crisis.18.h
		trigger = { is_gestalt = yes }
	}
}

# Notification
country_event = {
	id = crisis.1008
	title = "crisis.1008.name"
	desc = "crisis.1008.desc"
	picture = GFX_evt_physics_research
	show_sound = event_alien_signal
	is_triggered_only = yes

	option = {
		name = crisis.1008.a
		hidden_effect = {
			country_event = { id = crisis.1009 days = 30 }
		}
	}
}

# Threat Identified
country_event = {
	id = crisis.1009
	title = "crisis.1007.name"
	desc = "crisis.1009.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:extradimensional_system
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = { exists = event_target:extradimensional_system }
			}
			random_system = {
				limit = { has_star_flag = extradimensional_origin_system }
				save_event_target_as = extradimensional_system
			}
		}
	}

	after = {
		begin_event_chain = { event_chain = "extradimensional_invasion_chain" target = root }
		if = { # Vfix patch
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			event_target:extradimensional_system = {
				random_fleet_in_system = {
					limit = { is_ship_size = dimensional_portal_ed }
					save_event_target_as = dimensional_portal
				}
			}
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.1
			name = "extradimensional_invasion_1_poi"
			desc = "extradimensional_invasion_1_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:extradimensional_system
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.4
			name = "extradimensional_invasion_4_poi"
			desc = "extradimensional_invasion_4_poi_desc"
			event_chain = "extradimensional_invasion_chain"
			location = event_target:dimensional_portal # Vfix minor
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain"
				counter = "dimensional_anchors_1"
				amount = 1
			}
			country_event = { id = crisis.1010 }
		}
		if = {
			limit = {
				any_planet_within_border = {
					has_planet_flag = fotd_seperatist_planet@root
					owner = { has_country_flag = fotd_seperatist_country@root }
				}
			}
			country_event = { id = origin.6130 days = 5 random = 2 }
		}
	}

	option = {
		name = crisis.18.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_government = gov_wilderness
				has_government = gov_parasitic_overmind
				has_government = gov_successor_khanate
				has_government = gov_diadochi
				is_fallen_empire = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_egalitarian"
				has_ethic = "ethic_fanatic_authoritarian"
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
	}
	option = {
		name = crisis.18.g
		trigger = { has_ethic = "ethic_fanatic_xenophobe" }
	}
	option = {
		name = crisis.1007.a
		trigger = { has_ethic = "ethic_fanatic_xenophile" }
	}
	option = {
		name = crisis.1007.b
		trigger = { has_ethic = "ethic_fanatic_authoritarian" }
	}
	option = {
		name = crisis.18.j
		trigger = { has_ethic = "ethic_fanatic_egalitarian" }
	}
	option = {
		name = crisis.18.h
		trigger = { is_gestalt = yes }
	}
}

# Intercepted Transmission
country_event = {
	id = crisis.1010
	title = "crisis.1010.name"
	diplomatic_title = BLANK_STRING
	desc = "crisis.1010.desc"
	diplomatic = yes
	location = event_target:extradimensional_system

	picture_event_data = {
		portrait = exd1
		room = "extradimensional_blue_room"
	}

	is_triggered_only = yes

	immediate = {
		establish_communications_no_message = event_target:extradimensionals
	}

	option = {
		name = crisis.1010.a
	}
}

# Colony Bombarded
planet_event = {
	id = crisis.1011
	title = "crisis.1011.name"
	desc = "crisis.1011.desc"
	picture = GFX_evt_city_ruins
	show_sound = event_ghost_town
	is_triggered_only = yes

	trigger = {
		planet_devastation > 99
		from = {
			OR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
		}
	}

	immediate = {
		add_threat = { who = from amount = 2 }
		if = {
			limit = { is_artificial = no }
			random_list = {
				50 = { change_pc = pc_barren }
				50 = { change_pc = pc_barren_cold }
			}
			reset_planet = yes
			add_modifier = { modifier = "terraforming_candidate" days = -1 }
		}
		else_if = {
			limit = { has_ringworld_output_boost = yes }
			change_pc = pc_ringworld_habitable_damaged
			reset_planet = yes
		}
		else_if = {
			limit = { is_planet_class = pc_habitat }
			spawn_habitat_cracker_effect = yes
		}
		from = {
			switch = { # Vfix opt
				trigger = is_country_type
				extradimensional = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain" counter = "extradimensional_planets_1" amount = 1 }
					}
				}
				extradimensional_2 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_2" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_2" counter = "extradimensional_planets_2" amount = 1 }
					}
				}
				extradimensional_3 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_3" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_3" counter = "extradimensional_planets_3" amount = 1 }
					}
				}
			}
		}
		destroy_colony = yes
		solar_system = {
			if = { # Build starbase if no other colonies are left
				limit = {
					NOT = {
						any_system_colony = {
							has_owner = yes
							NOT = { is_owned_by = from }
						}
					}
				}
				if = { # Vfix
					limit = { NOT = { exists = starbase } }
					create_starbase = {
						owner = from
						size = starbase_exd
						effect = { # Vfix Hack for extra aberrant and vehement!?
							set_starbase_size = starbase_exd_0
						}
					}
				}
				random_ship_in_system = {
					limit = { is_owned_by = from }
					ship_event = { id = crisis.1300 } # Check if starbase should be Anchor
					ship_event = { id = crisis.1310 } # Create system effect
				}
			}
		}
	}

	option = {
		name = crisis.1011.a
	}
}

# Portal Destroyed (HIDDEN)
country_event = {
	id = crisis.1012
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_country_type = extradimensional
		fromfrom = { is_ship_size = dimensional_portal_ed }
	}

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_origin_system }
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = extradimensional_system_effect_2 }
				destroy_ambient_object = this
			}
		}
		if = {
			limit = {
				OR = {
					NOT = { has_global_flag = extradimensional_second_portal }
					AND = {
						has_global_flag = extradimensional_second_portal_destroyed
						has_global_flag = extradimensional_third_portal_destroyed
					}
				}
			}
			stop_crisis_sound = yes
			from = {
				save_event_target_as = portal_killer
				if = {
					limit = { is_ai = no }
					country_event = { id = crisis.1250 days = 10 random = 10 }
					set_country_flag = with_great_power_achievement
				}
			}
			observer_event = { id = observer.35 }
			every_playable_country = {
				if = {
					limit = { has_communications = from }
					add_opinion_modifier = { who = from modifier = opinion_destroyed_portal }
				}
				add_modifier = { modifier = "extradimensionals_defeated" years = 1 }
				country_event = { id = crisis.1013 }
			}
		}
		else_if = {
			limit = {
				has_global_flag = extradimensional_second_portal
				NOR = {
					has_global_flag = extradimensional_second_portal_destroyed
					has_global_flag = extradimensional_third_portal_destroyed
				}
			}
			every_playable_country = {
				country_event = { id = crisis.1016 }
			}
		}
	}
}

# Portal Destroyed
country_event = {
	id = crisis.1013
	title = "crisis.1013.name"
	desc = "crisis.1013.desc"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = { exists = event_target:extradimensional_system }
			}
			random_system = {
				limit = { has_star_flag = extradimensional_origin_system }
				save_event_target_as = extradimensional_system
			}
		}
		remove_point_of_interest = extradimensional_invasion_poi.1
		set_country_flag = extradimensionals_expunged
	}

	option = {
		name = crisis.1013.a
	}
}

# Portal Destroyed (Other Portals Exist)
country_event = {
	id = crisis.1016
	title = "crisis.1016.name"
	desc = "crisis.1016.desc"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				NOT = { exists = event_target:extradimensional_system }
			}
			random_system = {
				limit = { has_star_flag = extradimensional_origin_system }
				save_event_target_as = extradimensional_system
			}
		}
		set_global_flag = extradimensional_first_portal_destroyed
		remove_point_of_interest = extradimensional_invasion_poi.1
	}

	option = {
		name = crisis.1016.a
	}
}

# Unbidden Diplomacy
country_event = {
	id = crisis.1050
	title = "TRANSMISSION"

	desc = {
		text = crisis.1050.desc_01
		trigger = {
			NOR = {
				owner_species = { is_psionic_species = yes has_trait = trait_mechanical }
				is_machine_empire = yes
			}
		}
	}
	desc = {
		text = crisis.1050.desc_02
		trigger = {
			owner_species = { is_psionic_species = no }
		}
	}
	desc = {
		text = crisis.1050.desc_03
		trigger = {
			NOR = {
				owner_species = { is_psionic_species = yes has_trait = trait_mechanical }
				is_machine_empire = yes
			}
		}
	}
	desc = {
		text = crisis.1050.desc_04
		trigger = {
			owner_species = { is_psionic_species = yes }
		}
	}
	desc = {
		text = crisis.1050.desc_05
		trigger = {
			owner_species = { is_psionic_species = yes }
		}
	}
	desc = {
		text = crisis.1050.desc_06
		trigger = {
			owner_species = { is_psionic_species = yes }
		}
	}
	desc = {
		text = crisis.1050.desc_07
		trigger = {
			OR = {
				owner_species = { has_trait = trait_mechanical }
				is_machine_empire = yes
			}
		}
	}

	diplomatic = yes
	location = event_target:extradimensional_system
	force_open = yes

	picture_event_data = {
		portrait = exd1
		room = "extradimensional_blue_room"
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = extradimensional }
	}

	option = {
		name = crisis.1050.a
		response_text = crisis.1050.a.response
		trigger = {
			NOR = {
				is_machine_empire = yes
				owner_species = { has_trait = trait_mechanical }
			}
		}
	}
	option = {
		name = crisis.1050.b
		trigger = { is_pacifist = yes }
		response_text = crisis.1050.b.response
	}
	option = {
		name = crisis.1050.c
		trigger = {
			OR = {
				is_militarist = yes
				is_machine_empire = yes
			}
		}
		response_text = crisis.1050.c.response
	}
	option = {
		name = crisis.1050.d
		trigger = { is_xenophobe = yes }
		response_text = crisis.1050.d.response
	}
	option = {
		name = crisis.1050.e
		trigger = {
			is_xenophile = yes
			NOT = { owner_species = { has_trait = trait_mechanical } }
		}
		response_text = crisis.1050.e.response
	}
	option = {
		name = crisis.1050.f
		trigger = {
			is_spiritualist = yes
			owner_species = { is_psionic_species = no }
		}
		response_text = crisis.1050.f.response
	}
	option = {
		name = crisis.1050.g
		trigger = {
			owner_species = { is_psionic_species = yes }
		}
		response_text = crisis.1050.g.response
	}
	option = {
		name = crisis.1050.a
		response_text = crisis.1050.a.b.response
		trigger = {
			OR = {
				is_machine_empire = yes
				owner_species = { has_trait = trait_mechanical }
			}
		}
	}
}

# Aberrant Diplomacy
country_event = {
	id = crisis.1051
	title = "TRANSMISSION"

	desc = {
		text = crisis.1051.desc_01
	}
	desc = {
		text = crisis.1051.desc_02
	}
	desc = {
		text = crisis.1051.desc_03
	}
	desc = {
		text = crisis.1051.desc_04
		exclusive_trigger = {	# has_country_flag = works_with_formless # Happens if you have a Formless Admiral leader
			has_country_flag = allied_with_formless # Vfix proberly
		}
	}

	diplomatic = yes
	location = event_target:extradimensional_system
	force_open = yes

	picture_event_data = {
		portrait = exd2
		room = "extradimensional_orange_room"
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = extradimensional_2 }
	}

	option = {
		name = crisis.1051.a
		response_text = crisis.1051.a.response
	}
}

# Vehement Diplomacy
country_event = {
	id = crisis.1052
	title = "TRANSMISSION"

	desc = {
		text = crisis.1052.desc_01
	}
	desc = {
		text = crisis.1052.desc_02
	}
	desc = {
		text = crisis.1052.desc_03
	}

	diplomatic = yes
	location = event_target:extradimensional_system
	force_open = yes

	picture_event_data = {
		portrait = exd3
		room = "extradimensional_green_room"
	}

	is_triggered_only = yes

	trigger = {
		from = { is_country_type = extradimensional_3 }
	}

	option = {
		name = crisis.1052.a
		response_text = crisis.1052.a.response
	}
}

### Second Portal
# Second Portal Appears (HIDDEN)
# On yearly pulse
country_event = {
	id = crisis.1100
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_scope_valid = yes
		is_country_type = extradimensional
		# NOT = { has_global_flag = extradimensional_second_portal }
		# endgame_crisis_large_size_trigger = yes
	}

	# mean_time_to_happen = {
	# 	years = 1
	# }
	immediate = {
		set_crisis_sound = extradimensional_crisis_ambient_stage_3
		set_crisis_stage_3 = yes
		set_global_flag = extradimensional_second_portal
		random_system_within_border = {
			limit = {
				NOR = {
					is_system_home_to_crystalline_entity = yes
					is_binary_star = yes
					has_star_flag = crisis_spawn_exclude # Vfix
					has_star_flag = extradimensional_origin_system
				}
				NAND = { # Vfix
					num_cosmic_storms > 0
					is_inside_storm = yes
					is_storm_type = electric_storm
				}
			}
			set_star_flag = extradimensional_second_portal_system
			save_event_target_as = second_portal_system
			random_system_planet = {
				create_species = {
					name = "NAME_Aberrant"
					class = EXD
					namelist = Extradimensional
					portrait = exd2_leader
					traits = random
					effect = {
						save_event_target_as = extradimensional_hunters_species
					}
				}
				create_country = {
					name = "NAME_Aberrant"
					type = "extradimensional_2"
					species = event_target:extradimensional_hunters_species
					name_list = "Extradimensional"
					flag = {
						icon = { category = "special" file = "extradimensional_02.dds" }
						background = { category = "backgrounds" file = "triangle_split.dds" }
						colors = { "brown" "orange" "null" "null" }
					}
					effect = {
						set_country_flag = aberrant # Vfix: not used?
						create_ship_design = { design = "NAME_Void_Former" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Aberrant_Anchor" }
						add_ship_design = last_created_design
						create_ship_design = { design = "NAME_Unbidden_Starbase" }
						add_ship_design = last_created_design
						establish_communications_no_message = event_target:portal_holder_1
						set_faction_hostility = { target = event_target:portal_holder_1 set_hostile = no }
						save_global_event_target_as = extradimensionals2
						save_event_target_as = extradimensional_hunters
						set_graphical_culture = extra_dimensional_02
					}
				}
				event_target:extradimensional_hunters = {
					create_fleet = {
						name = "NAME_Dimensional_Portal"
						effect = {
							set_owner = prev
							create_ship = {
								name = random
								design = "NAME_Aberrant_Portal"
								graphical_culture = "extra_dimensional_02"
								effect = {
									set_ship_flag = aberrant_portal
								}
							}
							set_location = {
								target = prevprev
								distance = 40
								angle = random
							}
							save_event_target_as = second_portal
							fleet_event = { id = crisis.1103 days = 1 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 5 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 15 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 30 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 45 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 60 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 150 } # Fleet Arrives
							fleet_event = { id = crisis.1103 days = 350 } # Fleet Arrives
							fleet_event = { id = crisis.1106 days = 20 } # Constructor Arrives
							fleet_event = { id = crisis.1106 days = 25 } # Constructor Arrives
							fleet_event = { id = crisis.1106 days = 90 } # Constructor Arrives
							fleet_event = { id = crisis.1106 days = 210 } # Constructor Arrives
							prev = { country_event = { id = crisis.1260 days = 550 } } # Spawn Cycle starts
						}
					}
					create_leader = {
						class = commander
						species = event_target:extradimensional_hunters_species
						name = random
						skill = 3
						effect = {
							random_list = {
								25 = { add_trait = { trait = leader_trait_ethereal } }
								25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
								50 = {  }
							}
						}
					}
					create_fleet = {
						effect = {
							set_owner = prev
							while = {
								count = 21
								create_ship = {
									name = random
									design = "NAME_Huntress"
									graphical_culture = "extra_dimensional_02"
								}
							}
							while = {
								count = 30
								create_ship = {
									name = random
									design = "NAME_Assassin"
									graphical_culture = "extra_dimensional_02"
								}
							}
							while = {
								count = 45
								create_ship = {
									name = random
									design = "NAME_Predator"
									graphical_culture = "extra_dimensional_02"
								}
							}
							set_location = {
								target = event_target:second_portal
								distance = 5
								angle = random
							}
							set_fleet_stance = aggressive
							set_aggro_range = 500
							set_aggro_range_measure_from = self
							set_fleet_bombardment_stance = armageddon
							assign_leader = last_created_leader
						}
					}
				}
			}
			if = {
				limit = { exists = starbase }
				starbase = { destroy_fleet = fleet }
			}
			create_starbase = { owner = event_target:extradimensionals2 size = starbase_exd }
			star = {
				create_ambient_object = { type = "extradimensional_2" location = this }
				last_created_ambient_object = {
					set_ambient_object_flag = extradimensional_system_effect_2
					set_location = {
						target = prev
						distance = 0
						angle = random
					}
				}
			}
		}
		observer_event = { id = observer.36 }
		# make portal invincible
		event_target:extradimensional_hunters = {
			country_event = { id = crisis.1280 }
			establish_communications_no_message = root # Vfix opt
		}
		every_country = {
			limit = { is_default_or_fallen = yes }
			country_event = { id = crisis.1110 days = 1 }
		}
	}
}

# Fleet Reinforcements
fleet_event = {
	id = crisis.1103
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensional_hunters = {
			create_leader = {
				class = commander
				species = event_target:extradimensional_hunters_species
				name = random
				skill = 3
				effect = {
					random_list = {
						25 = { add_trait = { trait = leader_trait_ethereal } }
						25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
						50 = {  }
					}
				}
			}
			create_fleet = {
				effect = {
					set_owner = prev
					while = {
						count = 9
						create_ship = {
							name = random
							design = "NAME_Huntress"
							graphical_culture = "extra_dimensional_02"
						}
					}
					while = {
						count = 12
						create_ship = {
							name = random
							design = "NAME_Assassin"
							graphical_culture = "extra_dimensional_02"
						}
					}
					while = {
						count = 20
						create_ship = {
							name = random
							design = "NAME_Predator"
							graphical_culture = "extra_dimensional_02"
						}
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
					set_fleet_bombardment_stance = armageddon
					assign_leader = last_created_leader
				}
			}
		}
	}
}

# Constructor
fleet_event = {
	id = crisis.1106
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensional_hunters = {
			create_fleet = {
				effect = {
					set_owner = prev
					create_ship = {
						name = random
						design = "NAME_Void_Former"
						graphical_culture = "extra_dimensional_02"
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
				}
			}
		}
	}
}

# Second Portal Notification
country_event = {
	id = crisis.1110
	title = "crisis.1110.name"
	desc = "crisis.1110.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:second_portal_system
	is_triggered_only = yes

	immediate = {
		event_target:extradimensionals2 = { # Vfix opt
			establish_communications_no_message = root
		}
	}

	option = {
		name = crisis.1110.a
		begin_event_chain = {
			event_chain = "extradimensional_invasion_chain_2"
			target = root
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.2
			name = "extradimensional_invasion_2_poi"
			desc = "extradimensional_invasion_2_poi_desc"
			event_chain = "extradimensional_invasion_chain_2"
			location = event_target:second_portal_system
		}
		hidden_effect = {
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain_2"
				counter = "dimensional_anchors_2"
				amount = 1
			}
		}
	}
}

# Extradimensionals Fight Each Other (HIDDEN - on_fleet_destroyed_perp)
country_event = {
	id = crisis.1111
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		exists = from
		NOT = { has_global_flag = extradimensionals_fight }
		OR = {
			is_country_type = extradimensional
			is_country_type = extradimensional_2
		}
		from = {
			OR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
			}
		}
	}

	immediate = {
		set_global_flag = extradimensionals_fight
		every_playable_country = {
			country_event = { id = crisis.1112 }
		}
	}
}

# Extradimensionals Fight Each Other
country_event = {
	id = crisis.1112
	title = "crisis.1112.name"
	desc = "crisis.1112.desc"
	picture = GFX_evt_wormhole
	show_sound = event_alien_signal
	is_triggered_only = yes

	option = {
		name = crisis.1112.a
		hidden_effect = {
			country_event = { id = crisis.1113 }
		}
	}
}

# Transmission from Second Portal
country_event = {
	id = crisis.1113
	title = "TRANSMISSION"
	desc = "crisis.1113.desc"
	diplomatic = yes
	location = event_target:extradimensional_system

	picture_event_data = {
		portrait = exd2
		room = "extradimensional_orange_room"
	}

	is_triggered_only = yes

	option = {
		name = crisis.1113.a
	}
}

# Second Portal Destroyed (HIDDEN)
country_event = {
	id = crisis.1115
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_country_type = extradimensional_2
		fromfrom = { is_ship_size = dimensional_portal_ed }
	}

	immediate = {
		observer_event = { id = observer.37 }
		random_system = {
			limit = { has_star_flag = extradimensional_second_portal_system }
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = extradimensional_system_effect_2 }
				destroy_ambient_object = this
			}
		}
		if = {
			limit = {
				has_global_flag = extradimensional_first_portal_destroyed
				has_global_flag = extradimensional_third_portal_destroyed
			}
			stop_crisis_sound = yes
			every_playable_country = {
				country_event = { id = crisis.1116 }
			}
			from = { save_event_target_as = portal_killer }
			if = {
				limit = { from = { is_ai = no } }
				country_event = { id = crisis.1250 days = 10 random = 10 }
				set_country_flag = with_great_power_achievement
			}
			every_playable_country = {
				limit = { has_communications = from }
				add_opinion_modifier = { who = from modifier = opinion_destroyed_portal }
			}
			every_playable_country = {	# limit = { }
				add_modifier = { modifier = "extradimensionals_defeated" years = 1 }
			}
		}
		else = {
			every_playable_country = {
				country_event = { id = crisis.1117 }
			}
		}
	}
}

# Second Portal Destroyed
country_event = {
	id = crisis.1116
	title = "crisis.1116.name"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion

	desc = {
		text = "crisis.1116.desc.a"
		trigger = { has_communications = event_target:portal_killer }
	}
	desc = {
		text = "crisis.1116.desc.b"
		trigger = {
			NOT = { has_communications = event_target:portal_killer }
		}
	}

	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_second_portal_system }
			save_event_target_as = extradimensional_system
		}
		remove_point_of_interest = extradimensional_invasion_poi.2
		set_country_flag = extradimensionals_expunged
	}

	option = {
		name = crisis.1013.a
	}
}

# Second Portal Destroyed (Other Portals Exist)
country_event = {
	id = crisis.1117
	title = "crisis.1116.name"
	desc = "crisis.1117.desc"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion
	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_second_portal_system }
			save_event_target_as = extradimensional_system
		}
		set_global_flag = extradimensional_second_portal_destroyed
		remove_point_of_interest = extradimensional_invasion_poi.2
	}

	option = {
		name = crisis.1016.a
	}
}

### Third Portal
# Third Portal Appears (HIDDEN)
country_event = {
	id = crisis.1200
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_scope_valid = yes
		is_country_type = extradimensional_2
		# has_global_flag = extradimensionals_fight
		# NOT = { has_global_flag = extradimensional_third_portal }
		# exists = event_target:extradimensionals # Vfix opt any_country = { is_country_type = extradimensional }
	}

	# mean_time_to_happen = {
	# 	months = 40
	# }
	immediate = {
		set_global_flag = extradimensional_third_portal
		event_target:extradimensional_2 = {
			random_system_within_border = {
				limit = {
					NOR = {
						is_system_home_to_crystalline_entity = yes
						is_binary_star = yes
						has_star_flag = crisis_spawn_exclude # Vfix
						has_star_flag = extradimensional_origin_system
						has_star_flag = extradimensional_second_portal_system
					}
					NAND = { # Vfix
						num_cosmic_storms > 0
						is_inside_storm = yes
						is_storm_type = electric_storm
					}
				}
				set_star_flag = extradimensional_third_portal_system
				save_event_target_as = third_portal_system
				random_system_planet = {
					create_species = {
						name = "NAME_Vehement"
						class = EXD
						namelist = Extradimensional
						portrait = exd3_leader
						traits = random
						effect = {
							save_event_target_as = extradimensional_trespassers_species
						}
					}
					create_country = {
						name = "NAME_Vehement"
						type = "extradimensional_3"
						species = event_target:extradimensional_trespassers_species
						name_list = "Extradimensional"
						flag = {
							icon = { category = "special" file = "extradimensional_03.dds" }
							background = { category = "backgrounds" file = "stripe.dds" }
							colors = { "green" "teal" "null" "null" }
						}
						effect = {
							set_country_flag = vehement # Vfix: not used?
							create_ship_design = { design = "NAME_Void_Weaver" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Vehement_Anchor" }
							add_ship_design = last_created_design
							create_ship_design = { design = "NAME_Unbidden_Starbase" }
							add_ship_design = last_created_design
							establish_communications_no_message = event_target:portal_holder_1
							set_faction_hostility = { target = event_target:portal_holder_1 set_hostile = no }
							save_global_event_target_as = extradimensionals3
							save_event_target_as = extradimensional_trespassers
							set_graphical_culture = extra_dimensional_03
						}
					}
					event_target:extradimensional_trespassers = {
						create_fleet = {
							name = "NAME_Dimensional_Portal"
							effect = {
								set_owner = prev
								create_ship = {
									name = random
									design = "NAME_Vehement_Portal"
									graphical_culture = "extra_dimensional_03"
									effect = {
										set_ship_flag = vehement_portal
									}
								}
								set_location = {
									target = prevprev
									distance = 40
									angle = random
								}
								save_event_target_as = third_portal
								fleet_event = { id = crisis.1203 days = 1 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 5 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 15 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 30 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 45 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 60 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 150 } # Fleet Arrives
								fleet_event = { id = crisis.1203 days = 350 } # Fleet Arrives
								fleet_event = { id = crisis.1206 days = 20 } # Constructor Arrives
								fleet_event = { id = crisis.1206 days = 25 } # Constructor Arrives
								fleet_event = { id = crisis.1206 days = 90 } # Constructor Arrives
								fleet_event = { id = crisis.1206 days = 210 } # Constructor Arrives
								prev = { country_event = { id = crisis.1260 days = 550 } } # Spawn Cycle starts
							}
						}
						create_leader = {
							class = commander
							species = event_target:extradimensional_trespassers_species
							name = random
							skill = 3
							effect = {
								random_list = {
									25 = { add_trait = { trait = leader_trait_ethereal } }
									25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
									50 = {  }
								}
							}
						}
						create_fleet = {
							effect = {
								set_owner = prev
								while = {
									count = 21
									create_ship = {
										name = random
										design = "NAME_Eradicator"
										graphical_culture = "extra_dimensional_03"
									}
								}
								while = {
									count = 30
									create_ship = {
										name = random
										design = "NAME_Annihilator"
										graphical_culture = "extra_dimensional_03"
									}
								}
								while = {
									count = 45
									create_ship = {
										name = random
										design = "NAME_Obliterator"
										graphical_culture = "extra_dimensional_03"
									}
								}
								set_location = {
									target = event_target:third_portal
									distance = 5
									angle = random
								}
								set_fleet_stance = aggressive
								set_aggro_range = 500
								set_aggro_range_measure_from = self
								set_fleet_bombardment_stance = armageddon
								assign_leader = last_created_leader
							}
						}
					}
				}
				if = {
					limit = { exists = starbase }
					starbase = { destroy_fleet = fleet }
				}
				create_starbase = {
					owner = event_target:extradimensional_trespassers
					size = starbase_exd
				}
				star = {
					create_ambient_object = { type = "extradimensional_2" location = this }
					last_created_ambient_object = {
						set_ambient_object_flag = extradimensional_system_effect_2
						set_location = {
							target = prev
							distance = 0
							angle = random
						}
					}
				}
			}
			establish_communications_no_message = event_target:extradimensional_trespassers
		}
		observer_event = { id = observer.38 }
		# make portal invincible
		event_target:extradimensional_trespassers = {
			country_event = { id = crisis.1280 }
			establish_communications_no_message = root
		}
		every_country = {
			limit = { is_default_or_fallen = yes }
			country_event = { id = crisis.1210 days = 1 }
		}
	}
}

# Fleet Reinforcements
fleet_event = {
	id = crisis.1203
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensional_trespassers = {
			create_leader = {
				class = commander
				species = event_target:extradimensional_trespassers_species
				name = random
				skill = 3
				effect = {
					random_list = {
						25 = { add_trait = { trait = leader_trait_ethereal } }
						25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
						50 = {  }
					}
				}
			}
			create_fleet = {
				effect = {
					set_owner = prev
					while = {
						count = 9
						create_ship = {
							name = random
							design = "NAME_Eradicator"
							graphical_culture = "extra_dimensional_03"
						}
					}
					while = {
						count = 12
						create_ship = {
							name = random
							design = "NAME_Annihilator"
							graphical_culture = "extra_dimensional_03"
						}
					}
					while = {
						count = 20
						create_ship = {
							name = random
							design = "NAME_Obliterator"
							graphical_culture = "extra_dimensional_03"
						}
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
					set_fleet_stance = aggressive
					set_aggro_range = 500
					set_aggro_range_measure_from = self
					set_fleet_bombardment_stance = armageddon
					assign_leader = last_created_leader
				}
			}
		}
	}
}

# Constructor
fleet_event = {
	id = crisis.1206
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		event_target:extradimensional_trespassers = {
			create_fleet = {
				effect = {
					set_owner = prev
					create_ship = {
						name = random
						design = "NAME_Void_Weaver"
						graphical_culture = "extra_dimensional_03"
					}
					set_location = {
						target = root
						distance = 5
						angle = random
					}
				}
			}
		}
	}
}

# Third Portal Notification
country_event = {
	id = crisis.1210
	title = "crisis.1210.name"
	desc = "crisis.1210.desc"
	picture = GFX_evt_wormhole
	show_sound = event_ex_started
	location = event_target:third_portal_system
	is_triggered_only = yes

	immediate = {
		event_target:extradimensionals3 = { # Vfix opt
			establish_communications_no_message = root
		}
	}

	option = {
		name = crisis.1210.a
		begin_event_chain = {
			event_chain = "extradimensional_invasion_chain_3"
			target = root
		}
		create_point_of_interest = {
			id = extradimensional_invasion_poi.3
			name = "extradimensional_invasion_3_poi"
			desc = "extradimensional_invasion_3_poi_desc"
			event_chain = "extradimensional_invasion_chain_3"
			location = event_target:third_portal_system
		}
		hidden_effect = {	# owner = { # Vfix
			add_event_chain_counter = {
				event_chain = "extradimensional_invasion_chain_3"
				counter = "dimensional_anchors_3"
				amount = 1
			}
			country_event = { id = crisis.1211 }
		}
	}
}

# Transmission from Third Portal
country_event = {
	id = crisis.1211
	title = "TRANSMISSION"
	desc = "crisis.1211.desc"
	diplomatic = yes
	location = event_target:extradimensional_system

	picture_event_data = {
		portrait = exd3
		room = "extradimensional_green_room"
	}

	is_triggered_only = yes

	option = {
		name = crisis.1211.a
	}
}

# Third Portal Destroyed (HIDDEN)
country_event = {
	id = crisis.1215
	hide_window = yes
	fire_only_once = yes
	is_triggered_only = yes

	trigger = {
		is_country_type = extradimensional_3
		fromfrom = { is_ship_size = dimensional_portal_ed }
	}

	immediate = {
		observer_event = { id = observer.39 }
		random_system = {
			limit = { has_star_flag = extradimensional_third_portal_system }
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = extradimensional_system_effect_2 }
				destroy_ambient_object = this
			}
		}
		if = {
			limit = {
				has_global_flag = extradimensional_first_portal_destroyed
				has_global_flag = extradimensional_second_portal_destroyed
			}
			stop_crisis_sound = yes
			every_playable_country = {
				country_event = { id = crisis.1216 }
			}
			from = { save_event_target_as = portal_killer }
			if = {
				limit = { from = { is_ai = no } }
				country_event = { id = crisis.1250 days = 10 random = 10 }
				set_country_flag = with_great_power_achievement
			}
			every_playable_country = {
				limit = { has_communications = from }
				add_opinion_modifier = { who = from modifier = opinion_destroyed_portal }
			}
			every_playable_country = {	# limit = { }
				add_modifier = { modifier = "extradimensionals_defeated" years = 1 }
			}
		}
		else = {
			every_playable_country = {
				country_event = { id = crisis.1217 }
			}
		}
	}
}

# Third Portal Destroyed
country_event = {
	id = crisis.1216
	title = "crisis.1216.name"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion

	desc = {
		text = "crisis.1216.desc.a"
		trigger = { has_communications = event_target:portal_killer }
	}
	desc = {
		text = "crisis.1216.desc.b"
		trigger = {
			NOT = { has_communications = event_target:portal_killer }
		}
	}

	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_third_portal_system }
			save_event_target_as = extradimensional_system
		}
		remove_point_of_interest = extradimensional_invasion_poi.3
		set_country_flag = extradimensionals_expunged
	}

	option = {
		name = crisis.1013.a
	}
}

# Third Portal Destroyed (Other Portals Exist)
country_event = {
	id = crisis.1217
	title = "crisis.1216.name"
	desc = "crisis.1217.desc"
	picture = GFX_evt_wormhole
	show_sound = event_super_explosion
	is_triggered_only = yes

	immediate = {
		random_system = {
			limit = { has_star_flag = extradimensional_third_portal_system }
			save_event_target_as = extradimensional_system
		}
		set_global_flag = extradimensional_third_portal_destroyed
		remove_point_of_interest = extradimensional_invasion_poi.3
	}

	option = {
		name = crisis.1016.a
	}
}

# Destroy EXDs if no portals and only 5 or less ships remain
# On yearly pulse
event = {
	id = crisis.1254
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_global_flag = extradimensional_invasion_happened # Vfix opt
		NOT = { has_global_flag = extradimensional_invasion_defeated } # Vfix opt
		any_country = {
			OR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
		}
	}

	immediate = {
		if = {
			limit = { # Vfix (the whole mess)
				has_global_flag = extradimensional_first_portal_destroyed
				OR = {
					NOT = { has_global_flag = extradimensional_second_portal }
					AND = {
						has_global_flag = extradimensional_second_portal_destroyed
						OR = {
							NOT = { has_global_flag = extradimensional_third_portal }
							has_global_flag = extradimensional_third_portal_destroyed
						}
					}
				}
				any_country = {
					OR = {
						is_country_type = extradimensional
						is_country_type = extradimensional_2
						is_country_type = extradimensional_3
					}
					NOR = {
						num_ships > 5
						# any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
						event_target:portal_holder_1 = {
							any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
						}
						num_owned_planets > 0
						any_controlled_planet = { has_owner = yes }
					}
				}
			}
			every_country = {
				limit = {
					OR = {
						is_country_type = extradimensional
						is_country_type = extradimensional_2
						is_country_type = extradimensional_3
					}
				}
				destroy_country = yes # triggers crisis.1270
			}
		}
		else_if = {
			limit = {
				exists = event_target:extradimensionals
				NOT = { has_global_flag = extradimensional_second_portal }
				event_target:extradimensionals = { endgame_crisis_large_size_trigger = yes }
			}
			event_target:extradimensionals = {
				country_event = { id = crisis.1100 days = 30 }
			}
		}
		else_if = {
			limit = {
				has_global_flag = extradimensionals_fight
				exists = event_target:extradimensionals_2
				OR = {
					has_crisis_stage_3 = yes
					has_crisis_stage_4 = yes
				}
				NOT = { has_global_flag = extradimensional_third_portal }
			}
			if = {
				limit = {
					OR = {
						NOT = { exists = event_target:extradimensionals }
						has_crisis_stage_4 = yes
					}
				}
				event_target:extradimensionals_2 = {
					country_event = { id = crisis.1200 days = 180 }
				}
			}
			else = {
				event_target:extradimensionals_2 = {
					country_event = { id = crisis.1200 days = 540 random = 360 }
				}
			}
		}
	}
}

# Extradimensionals: Military Reinforcements Spawn Cycle (HIDDEN)
country_event = {
	id = crisis.1260
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		# OR = { implicit
		# 	is_country_type = extradimensional
		# 	is_country_type = extradimensional_2
		# 	is_country_type = extradimensional_3
		# }
		# Must only trigger if portal is still alive
		# OR = { any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
		exists = event_target:portal_holder_1
		event_target:portal_holder_1 = {
			any_controlled_fleet = { is_ship_size = dimensional_portal_ed is_within_borders_of = root }
		}
		# }
	}

	immediate = {
		country_event = { id = crisis.1266 days = 6 } # Spawn Construction Ships if needed
		export_trigger_value_to_variable = {
			trigger = count_controlled_fleet
			parameters = {
				limit = { is_ship_size = starbase_exd }
			}
			variable = num_anchors_exd
		}
		# If at fleet cap
		if = {
			limit = { num_ships > 2000 } # roughly 30-60 fleets (+ 100 starbase fleets)
			country_event = { id = crisis.1260 days = 600 random = 200 } # Check again later
		}
		# If no Anchors
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 0 }
			}
			country_event = { id = crisis.1265 days = 1500 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 1 }
			}
			country_event = { id = crisis.1265 days = 1300 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 2 }
			}
			country_event = { id = crisis.1265 days = 1100 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 3 }
			}
			country_event = { id = crisis.1265 days = 900 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 4 }
			}
			country_event = { id = crisis.1265 days = 600 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 5 }
			}
			country_event = { id = crisis.1265 days = 400 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 6 }
			}
			country_event = { id = crisis.1265 days = 400 random = 200 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 7 }
			}
			country_event = { id = crisis.1265 days = 300 random = 100 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 8 }
			}
			country_event = { id = crisis.1265 days = 250 random = 50 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value = 9 }
			}
			country_event = { id = crisis.1265 days = 200 random = 50 }
		}
		else_if = {
			limit = {
				check_variable = { which = num_anchors_exd value > 9 }
			}
			country_event = { id = crisis.1265 days = 150 random = 50 }
		}
	}
}

# Reinforcements Arrive (HIDDEN)
country_event = {
	id = crisis.1265
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		# Must only trigger if portal is still alive
		# OR = { any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
		exists = event_target:portal_holder_1
		event_target:portal_holder_1 = {
			any_controlled_fleet = { is_ship_size = dimensional_portal_ed is_within_borders_of = root }
		}
		# }
	}

	immediate = {
		if = { # Vfix opt
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			event_target:portal_holder_1 = {
				random_controlled_fleet = {
					limit = {
						is_ship_size = dimensional_portal_ed
						is_within_borders_of = prevprev
					}
					save_event_target_as = dimensional_portal
				}
			}
		}
		owner_species = { save_event_target_as = extradimensional_species }
		country_event = { id = crisis.1260 } # Restart spawn cycle
		# Create Admiral
		create_leader = {
			class = commander
			species = event_target:extradimensional_species
			name = random
			skill = 3
			effect = {
				random_list = {
					25 = { add_trait = { trait = leader_trait_ethereal } }
					25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
					50 = {  }
				}
			}
		}
		switch = { # Vfix opt
			trigger = is_country_type
			# Extradimensionals 1
			extradimensional = {	# Create Fleet
				create_fleet = {
					effect = {
						set_owner = root
						while = {
							count = 6
							create_ship = {
								name = random
								design = "NAME_Revenant"
								graphical_culture = "extra_dimensional_01"
							}
						}
						while = {
							count = 8
							create_ship = {
								name = random
								design = "NAME_Phantom"
								graphical_culture = "extra_dimensional_01"
							}
						}
						while = {
							count = 15
							create_ship = {
								name = random
								design = "NAME_Wraith"
								graphical_culture = "extra_dimensional_01"
							}
						}
					}
				}
			}
			# Extradimensionals 2
			extradimensional_2 = {	# Create Fleet
				create_fleet = {
					effect = {
						set_owner = root
						while = {
							count = 6
							create_ship = {
								name = random
								design = "NAME_Huntress"
								graphical_culture = "extra_dimensional_02"
							}
						}
						while = {
							count = 8
							create_ship = {
								name = random
								design = "NAME_Assassin"
								graphical_culture = "extra_dimensional_02"
							}
						}
						while = {
							count = 15
							create_ship = {
								name = random
								design = "NAME_Predator"
								graphical_culture = "extra_dimensional_02"
							}
						}
					}
				}
			}
			# Extradimensionals 3
			extradimensional_3 = {	# Create Fleet
				create_fleet = {
					effect = {
						set_owner = root
						while = {
							count = 6
							create_ship = {
								name = random
								design = "NAME_Eradicator"
								graphical_culture = "extra_dimensional_03"
							}
						}
						while = {
							count = 8
							create_ship = {
								name = random
								design = "NAME_Annihilator"
								graphical_culture = "extra_dimensional_03"
							}
						}
						while = {
							count = 15
							create_ship = {
								name = random
								design = "NAME_Obliterator"
								graphical_culture = "extra_dimensional_03"
							}
						}
					}
				}
			}
		}
		last_created_fleet = {
			set_location = {
				target = event_target:dimensional_portal
				distance = 5
				angle = random
			}
			set_fleet_stance = aggressive
			set_aggro_range = 500
			set_aggro_range_measure_from = self
			set_fleet_bombardment_stance = armageddon
			assign_leader = last_created_leader
		}
	}
}

# Construction Ships Arrive if Needed (HIDDEN)
country_event = {
	id = crisis.1266
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		# Must only trigger if portal is still alive
		# OR = { any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
		# has_global_flag = extradimensional_invasion_happened
		exists = event_target:portal_holder_1
		event_target:portal_holder_1 = {
			any_controlled_fleet = { is_ship_size = dimensional_portal_ed is_within_borders_of = root }
		}
		# }
		count_controlled_fleet = {
			count < 5 # Vfix balance
			limit = { is_ship_size = construction_ship_ed }
		}
	}

	immediate = {	# Extradimensionals 1
		if = { # Vfix opt
			limit = {
				NOT = { exists = event_target:dimensional_portal }
			}
			event_target:portal_holder_1 = {
				random_controlled_fleet = {
					limit = {
						is_ship_size = dimensional_portal_ed
						is_within_borders_of = prevprev
					}
					save_event_target_as = dimensional_portal
				}
			}
		}
		event_target:dimensional_portal.solar_system = {
			if = {
				limit = { NOT = { exists = starbase } }
				create_starbase = { owner = root size = starbase_exd }
			}
		}
		switch = { # Vfix opt
			trigger = is_country_type
			# Extradimensionals 1
			extradimensional = {
				while = {
					count = 2
					create_fleet = {
						effect = {
							set_owner = root
							create_ship = {
								name = random
								design = "NAME_Void_Shaper"
								graphical_culture = "extra_dimensional_01"
							}
							set_location = { target = event_target:dimensional_portal distance = 5 angle = random }
						}
					}
				}
			}
			# Extradimensionals 2
			extradimensional_2 = {
				while = {
					count = 2
					create_fleet = {
						effect = {
							set_owner = root
							create_ship = {
								name = random
								design = "NAME_Void_Former"
								graphical_culture = "extra_dimensional_02"
							}
							set_location = { target = event_target:dimensional_portal distance = 5 angle = random }
						}
					}
				}
			}
			# Extradimensionals 3
			extradimensional_3 = {
				while = {
					count = 2
					create_fleet = {
						effect = {
							set_owner = root
							create_ship = {
								name = random
								design = "NAME_Void_Weaver"
								graphical_culture = "extra_dimensional_03"
							}
							set_location = { target = event_target:dimensional_portal distance = 5 angle = random }
						}
					}
				}
			}
		}
	}
}

# Reinforcements Arrive After Building Anchor (HIDDEN)
ship_event = {
	id = crisis.1267
	hide_window = yes
	is_triggered_only = yes

	trigger = {	# is_ship_size = starbase_exd # now implicit
		exists = owner
		owner = {
			OR = { # Vfix double
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
			# Must only trigger if portal is still alive
			OR = {
				exists = event_target:dimensional_portal
				# any_controlled_fleet = { is_ship_size = dimensional_portal_ed }
				event_target:portal_holder_1 = {
					any_controlled_fleet = {
						is_ship_size = dimensional_portal_ed
						is_within_borders_of = prevprev
					}
				}
			}
			num_ships < 2001
		}
	}

	immediate = {
		owner = {
			country_event = { id = crisis.1266 days = 6 } # Spawn Construction Ships if needed
			if = { # Vfix opt
				limit = {
					NOT = { exists = event_target:dimensional_portal }
				}
				event_target:portal_holder_1 = { # Vfix opt
					random_controlled_fleet = {
						limit = {
							is_ship_size = dimensional_portal_ed
							is_within_borders_of = prevprev
						}
						save_event_target_as = dimensional_portal
					}
				}
			}
			owner_species = { save_event_target_as = extradimensional_species }
			# Create Admiral
			# Vfix patch: old admirals often survive the fleet kill, so there are more and more idling leaders in the pool
			if = {
				limit = {
					any_owned_leader = {
						leader_class = commander
						is_idle = yes
						NOR = {
							is_ruler = yes
							exists = fleet
						}
					}
				}
				if = {
					limit = {
						count_owned_leader = { count < 20 }
					}
					create_leader = {
						class = commander
						species = event_target:extradimensional_species
						name = random
						skill = 3
						effect = {
							random_list = {
								25 = { add_trait = { trait = leader_trait_ethereal } }
								25 = { add_trait = { trait = leader_trait_dimensional_stutter } }
								50 = {  }
							}
							save_event_target_as = exd_leader
						}
					}
				}
				else = {
					random_owned_leader = {
						limit = {
							leader_class = commander
							is_idle = yes
							NOR = {
								is_ruler = yes
								exists = fleet
							}
						}
						save_event_target_as = exd_leader
					}
				}
			}
			switch = { # Vfix opt
				trigger = is_country_type
				# Extradimensionals 1
				extradimensional = {	# Create Fleet
					create_fleet = {
						effect = {
							set_owner = root.owner
							while = {
								count = 6
								create_ship = {
									name = random
									design = "NAME_Revenant"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 8
								create_ship = {
									name = random
									design = "NAME_Phantom"
									graphical_culture = "extra_dimensional_01"
								}
							}
							while = {
								count = 15
								create_ship = {
									name = random
									design = "NAME_Wraith"
									graphical_culture = "extra_dimensional_01"
								}
							}
						}
					}
				}
				# Extradimensionals 2
				extradimensional_2 = {	# Create Fleet
					create_fleet = {
						effect = {
							set_owner = root.owner
							while = {
								count = 6
								create_ship = {
									name = random
									design = "NAME_Huntress"
									graphical_culture = "extra_dimensional_02"
								}
							}
							while = {
								count = 8
								create_ship = {
									name = random
									design = "NAME_Assassin"
									graphical_culture = "extra_dimensional_02"
								}
							}
							while = {
								count = 15
								create_ship = {
									name = random
									design = "NAME_Predator"
									graphical_culture = "extra_dimensional_02"
								}
							}
						}
					}
				}
				# Extradimensionals 3
				extradimensional_3 = {	# Create Fleet
					create_fleet = {
						effect = {
							set_owner = root.owner
							while = {
								count = 6
								create_ship = {
									name = random
									design = "NAME_Eradicator"
									graphical_culture = "extra_dimensional_03"
								}
							}
							while = {
								count = 8
								create_ship = {
									name = random
									design = "NAME_Annihilator"
									graphical_culture = "extra_dimensional_03"
								}
							}
							while = {
								count = 15
								create_ship = {
									name = random
									design = "NAME_Obliterator"
									graphical_culture = "extra_dimensional_03"
								}
							}
						}
					}
				}
			}
			last_created_fleet = {
				set_location = {
					target = event_target:dimensional_portal
					distance = 5
					angle = random
				}
				set_fleet_stance = aggressive
				set_aggro_range = 500
				set_aggro_range_measure_from = self
				set_fleet_bombardment_stance = armageddon
				assign_leader = event_target:exd_leader
			}
		}
	}
}

# Extradimensionals Defeated (HIDDEN) - on_country_destroyed
country_event = {
	id = crisis.1270
	hide_window = yes
	is_triggered_only = yes
	fire_only_once = yes # Vfix opt

	trigger = {
		OR = {
			is_country_type = extradimensional
			is_country_type = extradimensional_2
			is_country_type = extradimensional_3
		}
		NOT = {
			any_country = {
				OR = {
					is_country_type = extradimensional
					is_country_type = extradimensional_2
					is_country_type = extradimensional_3
				}
				NOT = { is_same_empire = root }
			}
		}
	}

	immediate = {
		observer_event = { id = observer.40 }
		every_country = {
			limit = {
				is_default_or_fallen = yes # Vfix
			}
			country_event = { id = crisis.1271 }
		}
		set_global_flag = extradimensional_invasion_defeated
		# Vfix opt: cleanup
		remove_global_flag = extradimensionals_fight
		remove_global_flag = extradimensional_second_portal
		remove_global_flag = extradimensional_third_portal
		remove_global_flag = extradimensional_first_portal_destroyed
		remove_global_flag = extradimensional_second_portal_destroyed
		remove_global_flag = extradimensional_third_portal_destroyed
		end_crisis = yes
	}
}

# Extradimensionals Defeated
country_event = {
	id = crisis.1271
	title = "crisis.1271.name"
	desc = "crisis.1271.desc"
	picture = GFX_evt_crisis_defeated
	show_sound = event_celebration
	is_triggered_only = yes

	immediate = {
		end_event_chain = "extradimensional_invasion_chain"
		end_event_chain = "extradimensional_invasion_chain_2"
		end_event_chain = "extradimensional_invasion_chain_3"
	}

	option = { # Spiritualist Response
		name = crisis.1271.a
		trigger = {
			has_spiritualist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Militarist Response
		name = crisis.1271.b
		trigger = {
			has_militarist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Materialist Response
		name = crisis.1271.c
		trigger = {
			has_materialist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Pacifist Response
		name = crisis.1271.d
		trigger = {
			has_pacifist_government = yes
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Corporate Response
		name = crisis.1271.e
		trigger = {
			OR = {
				has_government = gov_megacorporation
				has_government = gov_trade_league
				is_megacorp = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Default Response
		name = crisis.211.f
		trigger = {
			OR = {
				has_generic_government = yes
				has_government = gov_enlightened_monarchy
				has_government = gov_elective_monarchy
				has_government = gov_hive_mind
				has_government = gov_wilderness
				has_government = gov_parasitic_overmind
				has_government = gov_successor_khanate
				has_government = gov_diadochi
				is_fallen_empire_machine = yes
			}
			NOR = {
				has_ethic = "ethic_fanatic_xenophile"
				has_ethic = "ethic_fanatic_xenophobe"
			}
		}
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Xenophobe Response
		name = crisis.1271.g
		trigger = { has_ethic = "ethic_fanatic_xenophobe" }
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}
	option = { # Xenophile Response
		name = crisis.1271.h
		trigger = { has_ethic = "ethic_fanatic_xenophile" }
		add_monthly_resource_mult = { resource = unity value = @tier5unityreward }
	}

	after = {
		if = {
			limit = { has_origin = origin_fear_of_the_dark }
			country_event = { id = origin.6136 }
		}
	}
}

# Anchor Built (HIDDEN)
country_event = {
	id = crisis.1280
	hide_window = yes
	is_triggered_only = yes
	# trigger # Vfix now implicit
	immediate = {	# log = "anchor built and crisis.1280 executed, not yet reaching fleet owner switch"
		if = {  # Vfix sync
			limit = {
				NOT = { exists = event_target:portal_holder_1 }
			}
			random_country = {
				limit = { is_country_type = portal_holder }
				save_global_event_target_as = portal_holder_1
			}
		}
		if = {  # Vfix sync
			limit = { exists = event_target:portal_holder_1 }
			random_controlled_fleet = {
				limit = { is_ship_size = dimensional_portal_ed }
				set_event_locked = yes
				set_owner = event_target:portal_holder_1
				# log = "anchor built and crisis.1280 executed, reaching fleet owner switch"
			}
			switch = { # Vfix opt
				trigger = is_country_type
				extradimensional = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain" counter = "dimensional_anchors_1" amount = 1 }
					}
				}
				extradimensional_2 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_2" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_2" counter = "dimensional_anchors_2" amount = 1 }
					}
				}
				extradimensional_3 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_3" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_3" counter = "dimensional_anchors_3" amount = 1 }
					}
				}
			}
		}
	}
}

# DEPRECATED: Anchor Destroyed (HIDDEN)
# Vfix opt: on_ship_destroyed_victim is too expensive,
country_event = {
	id = crisis.1281
	hide_window = yes
	is_triggered_only = yes
	is_test_event = yes

	trigger = {
		always = no
	}
}

# id = crisis.1281 moved for compatibility
# Extradimensional Kill Count (HIDDEN)
country_event = {
	id = crisis.1282
	hide_window = yes
	is_triggered_only = yes

	trigger = {	# Vfix TODO another flag?
		has_global_flag = extradimensional_invasion_happened
		OR = {
			is_country_type = extradimensional
			is_country_type = extradimensional_2
			is_country_type = extradimensional_3
		}
	}

	immediate = {
		switch = { trigger = is_country_type
			extradimensional = {
				from = {
					if = {
						limit = { has_event_chain = "extradimensional_invasion_chain" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain" counter = "extradimensional_kills_us_1" amount = 1 }
					}
				}
				every_playable_country = {
					limit = {
						has_event_chain = "extradimensional_invasion_chain"
						NOT = { is_same_value = from }
					}
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain" counter = "extradimensional_kills_others_1" amount = 1 }
				}
			}
			extradimensional_2 = {
				from = {
					if = {
						limit = { has_event_chain = "extradimensional_invasion_chain_2" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_2" counter = "extradimensional_kills_us_2" amount = 1 }
					}
				}
				every_playable_country = {
					limit = {
						has_event_chain = "extradimensional_invasion_chain_2"
						NOT = { is_same_value = from }
					}
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_2" counter = "extradimensional_kills_others_2" amount = 1 }
				}
			}
			extradimensional_3 = {
				from = {
					if = {
						limit = { has_event_chain = "extradimensional_invasion_chain_3" }
						add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_3" counter = "extradimensional_kills_us_3" amount = 1 }
					}
				}
				every_playable_country = {
					limit = {
						has_event_chain = "extradimensional_invasion_chain_3"
						NOT = { is_same_value = from }
					}
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_3" counter = "extradimensional_kills_others_3" amount = 1 }
				}
			}
		}
	}
}

# Extradimensional Victims (HIDDEN - on_ship_destroyed_perp)
country_event = {
	id = crisis.1283
	hide_window = yes
	is_triggered_only = yes

	trigger = {	# Vfix TODO another flag?
		has_global_flag = extradimensional_invasion_happened
		OR = {
			is_country_type = extradimensional
			is_country_type = extradimensional_2
			is_country_type = extradimensional_3
		}
		from = {
			NOR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
		}
	}

	immediate = {
		switch = { trigger = is_country_type
			extradimensional = {
				every_playable_country = {
					limit = { has_event_chain = "extradimensional_invasion_chain" }
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain" counter = "extradimensional_victims_1" amount = 1 }
				}
			}
			extradimensional_2 = {
				every_playable_country = {
					limit = { has_event_chain = "extradimensional_invasion_chain_2" }
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_2" counter = "extradimensional_victims_2" amount = 1 }
				}
			}
			extradimensional_3 = {
				every_playable_country = {
					limit = { has_event_chain = "extradimensional_invasion_chain_3" }
					add_event_chain_counter = { event_chain = "extradimensional_invasion_chain_3" counter = "extradimensional_victims_3" amount = 1 }
				}
			}
		}
	}
}

# Events to manage crisis sound loop
# Vfix OPT: all MTTH merged into one without
event = {
	id = crisis.1230
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		# Vfix: Unfortunately the crisis has no _ongoing flag as the other ones (so we need 2 flag check)
		has_global_flag = extradimensional_invasion_happened
		NOT = { has_global_flag = extradimensional_invasion_defeated }
	}

	immediate = {
		event_target:global_event_country = {
			set_variable = { which = exd_galaxy_percentage value = 0 }
			every_country = {
				limit = {
					OR = {
						is_country_type = extradimensional
						is_country_type = extradimensional_2
						is_country_type = extradimensional_3
					}
				}
				prev = {
					set_variable = { which = tmp_exd_gal_pct value = prev.trigger:galaxy_percentage }
					if = {
						limit = {
							check_variable = { which = tmp_exd_gal_pct value > exd_galaxy_percentage }
						}
						set_variable = { which = exd_galaxy_percentage value = tmp_exd_gal_pct }
					}
				}
			}
			clear_variable = tmp_exd_gal_pct
			switch = { trigger = has_global_flag
				crisis_stage_4 = {
					if = {
						limit = { check_variable = { which = exd_galaxy_percentage value < 0.26 } }
						set_crisis_sound = extradimensional_crisis_ambient_stage_3
						set_crisis_stage_3 = yes
					}
				}
				crisis_stage_3 = {
					if = {
						limit = { check_variable = { which = exd_galaxy_percentage value > 0.30 } }
						set_crisis_sound = extradimensional_crisis_ambient_stage_final
						set_crisis_stage_4 = yes
					}
					else_if = {
						limit = { check_variable = { which = exd_galaxy_percentage value < 0.11 } }
						set_crisis_sound = extradimensional_crisis_ambient_stage_2
						set_crisis_stage_2 = yes
					}
				}
				crisis_stage_2 = {
					if = {
						limit = { check_variable = { which = exd_galaxy_percentage value > 0.15 } }
						set_crisis_sound = extradimensional_crisis_ambient_stage_3
						set_crisis_stage_3 = yes
					}
				}
				crisis_stage_1 = {
					if = {
						limit = { check_variable = { which = exd_galaxy_percentage value > 0.05 } }
						set_crisis_sound = extradimensional_crisis_ambient_stage_2
						set_crisis_stage_2 = yes
					}
				}
			}
		}
	}
}

# country_event = {
# 	id = crisis.1231
# 	hide_window = yes
# 	is_test_event = yes
# 	trigger = {
# 		always = no
# 		# has_crisis_stage_2 = yes
# 		# OR = {
# 		# 	is_country_type = extradimensional
# 		# 	is_country_type = extradimensional_2
# 		# 	is_country_type = extradimensional_3
# 		# }
# 		# endgame_crisis_large_size_trigger = yes
# 		## Vfix: why double check??
# 		## any_country = {
# 		## 	OR = {
# 		## 		is_country_type = extradimensional
# 		## 		is_country_type = extradimensional_2
# 		## 		is_country_type = extradimensional_3
# 		## 	}
# 		## 	galaxy_percentage > 0.15
# 		## }
# 	}
# 	# mean_time_to_happen = {
# 	# 	months = 1
# 	# }
# 	immediate = {
# 		set_crisis_sound = extradimensional_crisis_ambient_stage_3
# 		set_crisis_stage_3 = yes
# 	}
# }
# country_event = {
# 	id = crisis.1232
# 	hide_window = yes
# 	is_test_event = yes
# 	trigger = {
# 		always = no
# 		# has_crisis_stage_4 = yes
# 		# OR = {
# 		# 	is_country_type = extradimensional
# 		# 	is_country_type = extradimensional_2
# 		# 	is_country_type = extradimensional_3
# 		# }
# 		# NOT = {
# 		# 	any_country = {
# 		# 		OR = {
# 		# 			is_country_type = extradimensional
# 		# 			is_country_type = extradimensional_2
# 		# 			is_country_type = extradimensional_3
# 		# 		}
# 		# 		galaxy_percentage > 0.25
# 		# 	}
# 		# }
# 	}
# 	# mean_time_to_happen = {
# 	# 	months = 1
# 	# }
# 	immediate = {
# 		set_crisis_sound = extradimensional_crisis_ambient_stage_3
# 		set_crisis_stage_3 = yes
# 	}
# }
# country_event = {
# 	id = crisis.1233
# 	hide_window = yes
# 	is_test_event = yes
# 	trigger = {
# 		always = no
# 		# has_crisis_stage_3 = yes
# 		# OR = {
# 		# 	is_country_type = extradimensional
# 		# 	is_country_type = extradimensional_2
# 		# 	is_country_type = extradimensional_3
# 		# }
# 		# galaxy_percentage > 0.30
# 		# Vfix: why double check??
# 		# any_country = {
# 		# 	OR = {
# 		# 		is_country_type = extradimensional
# 		# 		is_country_type = extradimensional_2
# 		# 		is_country_type = extradimensional_3
# 		# 	}
# 		# 	galaxy_percentage > 0.30
# 		# }
# 	}
# 	# mean_time_to_happen = {
# 	# 	months = 1
# 	# }
# 	immediate = {
# 		set_crisis_sound = extradimensional_crisis_ambient_stage_final
# 		set_crisis_stage_4 = yes
# 	}
# }
# country_event = {
# 	id = crisis.1234
# 	hide_window = yes
# 	is_test_event = yes
# 	trigger = {
# 		always = no
# 		# has_crisis_stage_1 = yes
# 		# OR = {
# 		# 	is_country_type = extradimensional
# 		# 	is_country_type = extradimensional_2
# 		# 	is_country_type = extradimensional_3
# 		# }
# 		# galaxy_percentage > 0.05
# 		# Vfix: why double check??
# 		# any_country = {
# 		# 	OR = {
# 		# 		is_country_type = extradimensional
# 		# 		is_country_type = extradimensional_2
# 		# 		is_country_type = extradimensional_3
# 		# 	}
# 		# 	galaxy_percentage > 0.05
# 		# }
# 	}
# 	# mean_time_to_happen = {
# 	# 	months = 1
# 	# }
# 	immediate = {
# 		set_crisis_sound = extradimensional_crisis_ambient_stage_2
# 		set_crisis_stage_2 = yes
# 	}
# }
# Warlock Captured
country_event = {
	id = crisis.1250
	title = "crisis.1250.name"
	desc = "crisis.1250.desc"
	picture = GFX_evt_surreal_visions
	show_sound = event_mystic_reveal
	is_triggered_only = yes

	option = {
		name = GOOD
		add_relic = r_unbidden_warlock
	}
}

# Build Anchors
ship_event = {
	id = crisis.1300
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = owner
		owner = {
			count_starbase_sizes = { starbase_size = starbase_exd count < 10 }
			count_starbase_sizes = { starbase_size = starbase_exd_0 count < 100 }
		}
	}

	immediate = {
		owner = {	# Vfix opt (count several times up to 100 is wasting)
			export_trigger_value_to_variable = {
				trigger = count_starbase_sizes
				parameters = { starbase_size = starbase_exd_0 }
				variable = starbase_exd_0
			}
			# 1. Initialize threshold with the starbase count
			export_trigger_value_to_variable = {
				trigger = count_starbase_sizes
				parameters = { starbase_size = starbase_exd }
				variable = starbase_exd
			}
			# 2. Lower Clamp: Ensure we never require less than 10 (Fixes the 0 case)
			if = {
				limit = {
					check_variable = { which = starbase_exd value < 1 }
				}
				set_variable = { which = starbase_exd value = 1 }
			}
			# 3. Apply the ratio (1:10)
			multiply_variable = { which = starbase_exd value = 10 }
			if = {
				limit = {
					OR = {
						check_variable = { which = starbase_exd_0 value >= 90 }
						check_variable = { which = starbase_exd_0 value >= starbase_exd }
					}
				}
				prev = {
					ship_event = { id = crisis.1301 days = 1 }
				}
			}
			clear_variable = starbase_exd_0
			clear_variable = starbase_exd
		}
	}
}

# Build Anchors
ship_event = {
	id = crisis.1301
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		exists = owner
		exists = solar_system
	}

	immediate = {
		solar_system = {
			starbase = { set_starbase_size = starbase_exd }
		}
		ship_event = { id = crisis.1267 } # Reinforcements Arrive After Building Anchor
		owner = { country_event = { id = crisis.1280 } } # Anchor Built
	}
}

# Spawn System Effect
ship_event = {
	id = crisis.1310
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		solar_system = {
			if = {
				limit = {
					NOT = { any_system_ambient_object = { has_ambient_object_flag = extradimensional_system_effect } }
				}
				star = {
					create_ambient_object = { type = "extradimensional_1" location = this }
					last_created_ambient_object = {
						set_ambient_object_flag = extradimensional_system_effect
						set_location = {
							target = prev
							distance = 0
							angle = random
						}
					}
				}
			}
		}
	}
}

# DEPRECATED: Remove System Effect
# Vfix opt: on_ship_destroyed_victim is too expensive,
#  just take a starbase_event as crisis.1320
country_event = {
	id = crisis.1311
	hide_window = yes
	is_triggered_only = yes
	is_test_event = yes

	trigger = {
		always = no
	}
}

# Extradimensionals Destroyed Starbase
starbase_event = {
	id = crisis.1320
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_global_flag = extradimensional_invasion_happened
		# NOT = { has_global_flag = extradimensional_invasion_defeated }
		from.owner = {
			OR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
		}
		NOT = {
			solar_system = {
				any_system_colony = { has_owner = yes }
				# For populated systems, they need to destroy the colonies
			}
		}
	}

	immediate = {
		solar_system = { save_event_target_as = starbase_system }
		from.owner = {
			country_event = { id = crisis.1321 days = 5 }
			# Delay so that destroyed starbase is properly cleared out
		}
	}
}

# Extradimensionals Build New Starbase
country_event = {
	id = crisis.1321
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = { # Vfix
				NOT = { exists = event_target:starbase_system }
				exists = fromfrom
				exists = fromfrom.solar_system # theoretically, it is possible that they may have jumped
			}
			fromfrom.solar_system = { save_event_target_as = starbase_system }
		}
		event_target:starbase_system = {
			every_system_planet = {
				limit = { has_orbital_station = yes }
				orbital_station = { dismantle = yes }
			}
			if = { # Vfix
				limit = { NOT = { exists = starbase } }
				create_starbase = {
					owner = root
					size = starbase_exd
					effect = {  # Vfix Hack for extra aberrant and vehement!?
						set_starbase_size = starbase_exd_0
					}
				}
			}
			random_ship_in_system = {
				limit = { is_owned_by = root }
				ship_event = { id = crisis.1300 } # Check if starbase should be Anchor
				ship_event = { id = crisis.1310 } # Create system effect
			}
		}
	}
}
