############################
#
# CRISIS EVENTS I-III
#
# Vfix by FirePrince 12/2025
#
############################

namespace = crisis

### Crisis Events I (Swarm)
# Sentinel Reinforcements (on_five_year_pulse)
# NEW Vfix patch
event = {
	id = crisis.233 # (TODO do not override an existing id)
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_global_flag = ongoing_prethoryn_invasion
		has_global_flag = sentinels_founded
		exists = event_target:sentinel_alpha
		any_country = { is_country_type = sentinels num_ships < 200 }
	}

	immediate = {
		event_target:sentinel_alpha = {
			fleet_event = { id = crisis.60 }
		}
	}
}

### Crisis Events II (extradimensionals)
# NEW Vfix patch opt by FirePrince
# Anchor Destroyed (HIDDEN)
starbase_event = {
	id = crisis.1284
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		has_starbase_size = starbase_exd
		has_global_flag = extradimensional_invasion_happened
		exists = owner
		owner = {
			OR = {
				is_country_type = extradimensional
				is_country_type = extradimensional_2
				is_country_type = extradimensional_3
			}
		}
	}

	immediate = {
		log = "anchor destroyed event crisis.1284 triggered"
		owner = {
			save_event_target_as = starbase_exd_owner
			switch = { # Vfix opt
				trigger = is_country_type
				extradimensional = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain" }
						add_event_chain_counter = {
							event_chain = "extradimensional_invasion_chain"
							counter = "dimensional_anchors_1"
							amount = -1
						}
					}
					if = {
						limit = {
							NOT = { any_controlled_fleet = { is_ship_size = starbase_exd } }
						}
						event_target:portal_holder_1 = { # Vfix opt
							random_controlled_ship = {
								limit = {
									is_ship_size = dimensional_portal_ed
									has_ship_flag = unbidden_portal
								}
								fleet = { set_owner = root set_event_locked = no }
							}
						}
					}
				}
				extradimensional_2 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_2" }
						add_event_chain_counter = {
							event_chain = "extradimensional_invasion_chain_2"
							counter = "dimensional_anchors_2"
							amount = -1
						}
					}
					if = {
						limit = {
							NOT = { any_controlled_fleet = { is_ship_size = starbase_exd } }
						}
						event_target:portal_holder_1 = { # Vfix opt
							random_controlled_ship = {
								limit = {
									is_ship_size = dimensional_portal_ed
									has_ship_flag = aberrant_portal
								}
								fleet = { set_owner = root set_event_locked = no }
							}
						}
					}
				}
				extradimensional_3 = {
					every_playable_country = {
						limit = { has_event_chain = "extradimensional_invasion_chain_3" }
						add_event_chain_counter = {
							event_chain = "extradimensional_invasion_chain_3"
							counter = "dimensional_anchors_3"
							amount = -1
						}
					}
					if = {
						limit = {
							NOT = { any_controlled_fleet = { is_ship_size = starbase_exd } }
						}
						event_target:portal_holder_1 = { # Vfix opt
							random_controlled_ship = {
								limit = {
									is_ship_size = dimensional_portal_ed
									has_ship_flag = vehement_portal
								}
								fleet = { set_owner = root set_event_locked = no }
							}
						}
					}
				}
			}
		}
	}

	# Vfix Double check (as it is too risky for very important event)
	after = {
		event_target:starbase_exd_owner = {
			if = {
				limit = {
					NOT = { any_controlled_fleet = { is_ship_size = starbase_exd } }
				}
				# Vfix opt
				event_target:portal_holder_1 = {
					random_controlled_ship = {
						limit = {
							is_ship_size = dimensional_portal_ed
							OR = {
								AND = {
									prevprev = { has_country_flag = unbidden }
									has_ship_flag = unbidden_portal
								}
								AND = {
									prevprev = { has_country_flag = aberrant }
									has_ship_flag = aberrant_portal
								}
								AND = {
									prevprev = { has_country_flag = vehement }
									has_ship_flag = vehement_portal
								}
							}
						}
						fleet = { set_owner = root set_event_locked = no }
					}
				}
			}
		}
	}
}

# New Vfix opt by FirePrince
# Extradimensionals Starbase Destroyed: Remove System Effect
starbase_event = {
	id = crisis.1312
	hide_window = yes
	is_triggered_only = yes

	trigger = {
		OR = {
			has_starbase_size = starbase_exd_0
			has_starbase_size = starbase_exd
		}
		# exists = owner
		# owner = {
		# 	OR = {
		# 		is_country_type = extradimensional
		# 		is_country_type = extradimensional_2
		# 		is_country_type = extradimensional_3
		# 	}
		# }
	}

	immediate = {
		solar_system = {
			random_system_ambient_object = {
				limit = { has_ambient_object_flag = extradimensional_system_effect }
				destroy_ambient_object = this
			}
		}
	}
}
